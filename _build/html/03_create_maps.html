

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Create maps &#8212; stroke_unit_demographics</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=ac02cc09edc035673794" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=ac02cc09edc035673794" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=ac02cc09edc035673794" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=ac02cc09edc035673794" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" href="_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=ac02cc09edc035673794" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=ac02cc09edc035673794" />
  <script src="_static/vendor/fontawesome/6.1.2/js/all.min.js?digest=ac02cc09edc035673794"></script>

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script src="_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '03_create_maps';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="Create shapefiles" href="02_create_shapefiles.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="intro.html">
  
  
  
  
  
    <p class="title logo__title">stroke_unit_demographics</p>
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="intro.html">
                    Stroke unit demographics
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="01_combine_demographic_data.html">Collate demographic data for each LSOA</a></li>
<li class="toctree-l1"><a class="reference internal" href="01b_ambulance_trusts.html">Ambulance Trusts</a></li>
<li class="toctree-l1"><a class="reference internal" href="02_create_shapefiles.html">Create shapefiles</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Create maps</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/executablebooks/jupyter-book" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/executablebooks/jupyter-book/issues/new?title=Issue%20on%20page%20%2F03_create_maps.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/03_create_maps.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Create maps</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#set-up">1 Set up</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#import-libraries-and-define-file-paths">1.1 Import libraries and define file paths</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#load-data">1.2 Load data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#define-functions-for-calculating-weighted-mean-and-proportions">1.3 Define functions for calculating weighted mean and proportions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#extract-boundaries">1.4 Extract boundaries</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#define-mapping-functions">1.5 Define mapping functions</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#ivt-catchment-statistics">2 IVT catchment statistics</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#ivt-catchment-map">IVT catchment map</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#admissions-to-each-unit-2021-22">Admissions to each unit (2021-22)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#population-weighted-mean-income-domain-score-by-ivt-catchment">Population-weighted mean income domain score by IVT catchment</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#population-weighted-mean-imd-score-by-ivt-catchment">Population-weighted mean IMD score by IVT catchment</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#ivt-catchment-size">IVT catchment size</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#ethnicity-proportion-ethnic-minority-by-ivt-catchment">Ethnicity - proportion ethnic minority by IVT catchment</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#general-health-proportion-with-bad-very-bad-health-by-ivt-catchment">General health - proportion with bad/very bad health by IVT catchment</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#long-term-health-problem-or-disability-proportion-by-ivt-catchment">Long-term health problem or disability - proportion by IVT catchment</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#rural-urban-proportion-of-people-living-in-rural-areas-by-ivt-catchment">Rural/urban - proportion of people living in rural areas by IVT catchment</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#age-proportion-aged-65-by-ivt-catchment">Age - proportion aged 65+ by IVT catchment</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#thrombolysis-rates-for-each-ivt-unit">Thrombolysis rates for each IVT unit</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#population-density">Population density</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#average-travel-time-to-ivt-unit-weighted-by-number-of-over-65-year-olds-in-catchment">Average travel time to IVT unit weighted by number of over 65 year olds in catchment</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#proportion-of-65-year-olds-living-within-30-minutes-of-their-closest-ivt-unit">Proportion of 65+ year olds living within 30 minutes of their closest IVT unit</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#ambulance-service-statistics">3 Ambulance service statistics</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#ambulance-service-map">Ambulance service map</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#population-weighted-mean-time-to-ivt-unit-by-ambulance-trust">Population-weighted mean time to IVT unit by ambulance trust</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#population-weighted-mean-time-to-mt-unit-by-ambulance-trust">Population-weighted mean time to MT unit by ambulance trust</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#population-weighted-mean-transfer-time-between-ivt-and-mt-unit">Population-weighted mean transfer time between IVT and MT unit</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#proportion-of-patients-whose-nearest-hospital-is-an-mt-unit">Proportion of patients whose nearest hospital is an MT unit</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="create-maps">
<h1>Create maps<a class="headerlink" href="#create-maps" title="Permalink to this heading">#</a></h1>
<p>Using IVT catchment and ambulance trust shapefiles, create maps - for example, population weighted mean IMD score per IVT catchment, or mean transfer time by ambulance trust.</p>
<p>Notes:</p>
<ul class="simple">
<li><p>When using the 2018 age CSV file, there were two Welsh hospital catchments (CF311RQ Bridgend, CF144XW Cardiff) that each contained two LSOAs that are not present in that age file (Rhondda Cynon Taf 023F, Rhondda Cynon Taf 027F, Rhondda Cynon Taf 027G, Rhondda Cynon Taf 023G). Since we use the population count from this age csv file to calculate a weighted sum for the IVT catchment, these LSOAs were previously (1) excluded from the weighted mean, and (2) excluded from the map. However, in the 2020 age CSV file now used, these areas have data, so <strong>these steps are no longer required and have been removed</strong>.</p></li>
<li><p>To help with geopandas use <a class="github reference external" href="https://github.com/MichaelAllen1966/2010_geopandas/blob/main/geopandas_1.ipynb">MichaelAllen1966/2010_geopandas</a></p></li>
<li><p>Uses MatPlotLib for mapping the data since that gives us more power than the GeoPandas DataFrame plot method.</p></li>
</ul>
<section id="set-up">
<h2>1 Set up<a class="headerlink" href="#set-up" title="Permalink to this heading">#</a></h2>
<section id="import-libraries-and-define-file-paths">
<h3>1.1 Import libraries and define file paths<a class="headerlink" href="#import-libraries-and-define-file-paths" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">contextily</span> <span class="k">as</span> <span class="nn">ctx</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="nn">gpd</span>
<span class="kn">from</span> <span class="nn">mapclassify</span> <span class="kn">import</span> <span class="n">greedy</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib.transforms</span> <span class="kn">import</span> <span class="n">Bbox</span>
<span class="kn">from</span> <span class="nn">mpl_toolkits.axes_grid1.inset_locator</span> <span class="kn">import</span> <span class="n">mark_inset</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">pandas.api.types</span> <span class="kn">import</span> <span class="n">is_numeric_dtype</span>

<span class="c1"># Linting</span>
<span class="o">%</span><span class="k">load_ext</span> pycodestyle_magic
<span class="o">%</span><span class="k">pycodestyle_on</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define file paths</span>
<span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Paths</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Singleton object for storing paths to data and database.&#39;&#39;&#39;</span>

    <span class="n">data</span> <span class="o">=</span> <span class="s1">&#39;./data&#39;</span>
    <span class="n">collated</span> <span class="o">=</span> <span class="s1">&#39;collated_data_amb.csv&#39;</span>

    <span class="n">hospitals</span> <span class="o">=</span> <span class="s1">&#39;hospitals&#39;</span>
    <span class="n">stroke_hospitals</span> <span class="o">=</span> <span class="s1">&#39;stroke_hospitals_2022.csv&#39;</span>

    <span class="n">shapefiles</span> <span class="o">=</span> <span class="s1">&#39;shapefiles&#39;</span>
    <span class="n">ivt_catchment</span> <span class="o">=</span> <span class="s1">&#39;ivt_catchment.shp&#39;</span>
    <span class="n">amb_catchment</span> <span class="o">=</span> <span class="s1">&#39;amb_catchment.shp&#39;</span>
    <span class="n">countries</span> <span class="o">=</span> <span class="s1">&#39;Countries_(December_2022)_GB_BFC.zip&#39;</span>


<span class="n">paths</span> <span class="o">=</span> <span class="n">Paths</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="load-data">
<h3>1.2 Load data<a class="headerlink" href="#load-data" title="Permalink to this heading">#</a></h3>
<p>We convert data to epsg:3857, as that is needed when using base maps. Base maps are a reference map that you can then overlay your data onto - for example, a topographic basemap showing elevation. We can set the crs (Coordinate Reference System) when loading a GeoPandas DataFrame. CRS to consider:</p>
<ul class="simple">
<li><p>EPSG:27700 – BNG (British National Grid Eastings and Northings).</p></li>
<li><p>EPSG:27700 OSGB 1936 / British National Grid – United Kingdom Ordnance Survey. Co-ordinates are in Eastings (X) and Northings (Y).</p></li>
<li><p>EPSG:4326 WGS 84 – WGS84 - World Geodetic System 1984. Co-ordinates are in Longitude (X) and Latitude (Y).</p></li>
<li><p>EPSG:3857 - projection for displaying lat/long as a flat map</p></li>
</ul>
<p><strong>IVT catchment shapefile</strong> - shape file of the catchments for the IVT units in England and Wales, which we load into a GeoPandas DataFrame. Note that we can set the crs (Coordinate Reference System) when loading a GeoPandas DataFrame. EPSG:27700 is the crs to use when geography is in BNG (British National Grid Eastings and Northings). Note: If this fails to run, you need to run <code class="docutils literal notranslate"><span class="pre">02_create_ivt_catchment_shapefile.ipynb</span></code> to generate the IVT catchment shapefile.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load IVT catchment shapefile</span>
<span class="n">gdf_ivt_catchment</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span>
    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">paths</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">paths</span><span class="o">.</span><span class="n">shapefiles</span><span class="p">,</span> <span class="n">paths</span><span class="o">.</span><span class="n">ivt_catchment</span><span class="p">),</span>
    <span class="n">crs</span><span class="o">=</span><span class="s1">&#39;EPSG:27700&#39;</span><span class="p">)</span>

<span class="c1"># Set index</span>
<span class="n">gdf_ivt_catchment</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;closest_iv&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Preview the dataframe</span>
<span class="n">display</span><span class="p">(</span><span class="n">gdf_ivt_catchment</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>

<span class="c1"># Plot the shapefile</span>
<span class="n">gdf_ivt_catchment</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Convert crs to epsg 3857</span>
<span class="n">gdf_ivt_catchment</span> <span class="o">=</span> <span class="n">gdf_ivt_catchment</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">epsg</span><span class="o">=</span><span class="mi">3857</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>LSOA11CD</th>
      <th>LSOA11NM</th>
      <th>LSOA11NMW</th>
      <th>geometry</th>
    </tr>
    <tr>
      <th>closest_iv</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>B152TH</th>
      <td>E01008881</td>
      <td>Birmingham 067A</td>
      <td>Birmingham 067A</td>
      <td>MULTIPOLYGON (((403011.723 266679.152, 402597....</td>
    </tr>
    <tr>
      <th>B714HJ</th>
      <td>E01008899</td>
      <td>Birmingham 037A</td>
      <td>Birmingham 037A</td>
      <td>MULTIPOLYGON (((395950.714 272162.470, 395950....</td>
    </tr>
  </tbody>
</table>
</div></div><img alt="_images/afc10f8220f0c3fd5783b9aa69ec469126718223b45a32ff9625d7e73b2cc26b.png" src="_images/afc10f8220f0c3fd5783b9aa69ec469126718223b45a32ff9625d7e73b2cc26b.png" />
</div>
</div>
<p><strong>Country outline</strong> - used to produce outline of countries on the map.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load country outline</span>
<span class="n">outline</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
    <span class="n">paths</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">paths</span><span class="o">.</span><span class="n">shapefiles</span><span class="p">,</span> <span class="n">paths</span><span class="o">.</span><span class="n">countries</span><span class="p">))</span>

<span class="c1"># Drop Scotland</span>
<span class="n">mask</span> <span class="o">=</span> <span class="n">outline</span><span class="p">[</span><span class="s1">&#39;CTRY22NM&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;Scotland&#39;</span>
<span class="n">outline</span> <span class="o">=</span> <span class="n">outline</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>

<span class="c1"># Convert to epsg:3857</span>
<span class="n">outline</span> <span class="o">=</span> <span class="n">outline</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">epsg</span><span class="o">=</span><span class="mi">3857</span><span class="p">)</span>

<span class="c1"># Preview the dataframe</span>
<span class="n">display</span><span class="p">(</span><span class="n">outline</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>

<span class="c1"># Plot the shapefile</span>
<span class="n">outline</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>FID</th>
      <th>CTRY22CD</th>
      <th>CTRY22NM</th>
      <th>CTRY22NMW</th>
      <th>BNG_E</th>
      <th>BNG_N</th>
      <th>LONG</th>
      <th>LAT</th>
      <th>GlobalID</th>
      <th>SHAPE_Leng</th>
      <th>SHAPE_Area</th>
      <th>geometry</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>E92000001</td>
      <td>England</td>
      <td>Lloegr</td>
      <td>394883</td>
      <td>370883</td>
      <td>-2.07811</td>
      <td>53.23497</td>
      <td>{096C3540-B006-4D2D-BCDF-B3E945B80D51}</td>
      <td>1.358939e+07</td>
      <td>1.304623e+11</td>
      <td>MULTIPOLYGON (((-712384.210 6422975.926, -7123...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>W92000004</td>
      <td>Wales</td>
      <td>Cymru</td>
      <td>263405</td>
      <td>242881</td>
      <td>-3.99417</td>
      <td>52.06741</td>
      <td>{1DFA050A-C94B-4E58-8210-DE8274C7C33E}</td>
      <td>3.273688e+06</td>
      <td>2.078260e+10</td>
      <td>MULTIPOLYGON (((-347425.136 6688819.680, -3474...</td>
    </tr>
  </tbody>
</table>
</div></div><img alt="_images/0245cd241975c5c449acf2768ac9dcbd0a12e146fedd68197d6ef0267276be99.png" src="_images/0245cd241975c5c449acf2768ac9dcbd0a12e146fedd68197d6ef0267276be99.png" />
</div>
</div>
<p><strong>LSOA information</strong> - load <code class="docutils literal notranslate"><span class="pre">collated_data.csv</span></code> produced by <code class="docutils literal notranslate"><span class="pre">01_combine_demographic_data.ipynb</span></code> which has information on each LSOA.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_lsoa</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">paths</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">paths</span><span class="o">.</span><span class="n">collated</span><span class="p">))</span>
<span class="n">df_lsoa</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>LSOA</th>
      <th>admissions</th>
      <th>closest_ivt_unit</th>
      <th>closest_ivt_unit_time</th>
      <th>closest_mt_unit</th>
      <th>closest_mt_unit_time</th>
      <th>closest_mt_transfer</th>
      <th>closest_mt_transfer_time</th>
      <th>total_mt_time</th>
      <th>ivt_rate</th>
      <th>...</th>
      <th>age_band_males_65</th>
      <th>age_band_males_70</th>
      <th>age_band_males_75</th>
      <th>age_band_males_80</th>
      <th>age_band_males_85</th>
      <th>age_band_males_90</th>
      <th>ambulance_service</th>
      <th>local_authority_district_22</th>
      <th>LAD22NM</th>
      <th>country</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Welwyn Hatfield 010F</td>
      <td>0.666667</td>
      <td>SG14AB</td>
      <td>18.7</td>
      <td>NW12BU</td>
      <td>36.9</td>
      <td>CB20QQ</td>
      <td>39.1</td>
      <td>57.8</td>
      <td>6.8</td>
      <td>...</td>
      <td>33</td>
      <td>28</td>
      <td>26</td>
      <td>14</td>
      <td>5</td>
      <td>3</td>
      <td>East of England</td>
      <td>Welwyn Hatfield</td>
      <td>Welwyn Hatfield</td>
      <td>England</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Welwyn Hatfield 012A</td>
      <td>4.000000</td>
      <td>SG14AB</td>
      <td>19.8</td>
      <td>NW12BU</td>
      <td>36.9</td>
      <td>CB20QQ</td>
      <td>39.1</td>
      <td>58.9</td>
      <td>6.8</td>
      <td>...</td>
      <td>24</td>
      <td>18</td>
      <td>21</td>
      <td>12</td>
      <td>5</td>
      <td>4</td>
      <td>East of England</td>
      <td>Welwyn Hatfield</td>
      <td>Welwyn Hatfield</td>
      <td>England</td>
    </tr>
  </tbody>
</table>
<p>2 rows × 115 columns</p>
</div></div></div>
</div>
<p><strong>Hospital data</strong> - load data on each hospital, with aim of getting locations of hospitals that provide IVT.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Read in data on each hospital</span>
<span class="n">gdf_units</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span>
    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">paths</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">paths</span><span class="o">.</span><span class="n">hospitals</span><span class="p">,</span> <span class="n">paths</span><span class="o">.</span><span class="n">stroke_hospitals</span><span class="p">))</span>

<span class="c1"># Combine get geometry from Easting and Northing columns</span>
<span class="n">gdf_units</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">points_from_xy</span><span class="p">(</span>
        <span class="n">gdf_units</span><span class="o">.</span><span class="n">Easting</span><span class="p">,</span> <span class="n">gdf_units</span><span class="o">.</span><span class="n">Northing</span><span class="p">)</span>
<span class="n">gdf_units</span> <span class="o">=</span> <span class="n">gdf_units</span><span class="o">.</span><span class="n">set_crs</span><span class="p">(</span><span class="n">epsg</span><span class="o">=</span><span class="mi">27700</span><span class="p">)</span>

<span class="c1"># Restrict to the units delivering thrombolysis</span>
<span class="n">mask</span> <span class="o">=</span> <span class="n">gdf_units</span><span class="p">[</span><span class="s1">&#39;Use_IVT&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;1&#39;</span>
<span class="n">gdf_units</span> <span class="o">=</span> <span class="n">gdf_units</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>

<span class="c1"># Convert crs to epsg 3857</span>
<span class="n">gdf_units</span> <span class="o">=</span> <span class="n">gdf_units</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">epsg</span><span class="o">=</span><span class="mi">3857</span><span class="p">)</span>

<span class="c1"># Preview dataframe</span>
<span class="n">gdf_units</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Postcode</th>
      <th>Hospital_name</th>
      <th>Use_IVT</th>
      <th>Use_MT</th>
      <th>Use_MSU</th>
      <th>Country</th>
      <th>Strategic Clinical Network</th>
      <th>Health Board / Trust</th>
      <th>Stroke Team</th>
      <th>SSNAP name</th>
      <th>...</th>
      <th>ivt_rate</th>
      <th>Easting</th>
      <th>Northing</th>
      <th>long</th>
      <th>lat</th>
      <th>Neuroscience</th>
      <th>30 England Thrombectomy Example</th>
      <th>hospital_city</th>
      <th>Notes</th>
      <th>geometry</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>RM70AG</td>
      <td>RM70AG</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>England</td>
      <td>London SCN</td>
      <td>Barking</td>
      <td>Havering and Redbridge University Hospitals N...</td>
      <td>Queens Hospital Romford HASU</td>
      <td>...</td>
      <td>11.9</td>
      <td>551118</td>
      <td>187780</td>
      <td>0.179030640661934</td>
      <td>51.5686465521504</td>
      <td>1</td>
      <td>0</td>
      <td>Romford</td>
      <td></td>
      <td>POINT (19929.600 6722503.874)</td>
    </tr>
    <tr>
      <th>1</th>
      <td>E11BB</td>
      <td>E11BB</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>England</td>
      <td>London SCN</td>
      <td>Barts Health NHS Trust</td>
      <td>The Royal London Hospital</td>
      <td>Royal London Hospital HASU</td>
      <td>...</td>
      <td>13.4</td>
      <td>534829</td>
      <td>181798</td>
      <td>-0.0581329916047372</td>
      <td>51.5190178361295</td>
      <td>1</td>
      <td>1</td>
      <td>Royal London</td>
      <td></td>
      <td>POINT (-6471.335 6713620.606)</td>
    </tr>
  </tbody>
</table>
<p>2 rows × 22 columns</p>
</div></div></div>
</div>
<p><strong>Ambulance catchment shapefile</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load IVT catchment shapefile</span>
<span class="n">gdf_amb_catchment</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span>
    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">paths</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">paths</span><span class="o">.</span><span class="n">shapefiles</span><span class="p">,</span> <span class="n">paths</span><span class="o">.</span><span class="n">amb_catchment</span><span class="p">),</span>
    <span class="n">crs</span><span class="o">=</span><span class="s1">&#39;EPSG:27700&#39;</span><span class="p">)</span>

<span class="c1"># Set index</span>
<span class="n">gdf_amb_catchment</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;ambulance_&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Preview the dataframe</span>
<span class="n">display</span><span class="p">(</span><span class="n">gdf_amb_catchment</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>

<span class="c1"># Plot the shapefile</span>
<span class="n">gdf_amb_catchment</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Convert crs to epsg 3857</span>
<span class="n">gdf_amb_catchment</span> <span class="o">=</span> <span class="n">gdf_amb_catchment</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">epsg</span><span class="o">=</span><span class="mi">3857</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>LSOA11CD</th>
      <th>LSOA11NM</th>
      <th>LSOA11NMW</th>
      <th>geometry</th>
    </tr>
    <tr>
      <th>ambulance_</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>East Midlands</th>
      <td>E01013128</td>
      <td>North East Lincolnshire 010A</td>
      <td>North East Lincolnshire 010A</td>
      <td>MULTIPOLYGON (((433631.972 296489.554, 433631....</td>
    </tr>
    <tr>
      <th>East of England</th>
      <td>E01015589</td>
      <td>Peterborough 004A</td>
      <td>Peterborough 004A</td>
      <td>MULTIPOLYGON (((503939.688 193345.500, 503939....</td>
    </tr>
  </tbody>
</table>
</div></div><img alt="_images/4b7183c4b9444d9c75fed037aac0aa03c251f36050999d0b55a3f092130d7d77.png" src="_images/4b7183c4b9444d9c75fed037aac0aa03c251f36050999d0b55a3f092130d7d77.png" />
</div>
</div>
</section>
<section id="define-functions-for-calculating-weighted-mean-and-proportions">
<h3>1.3 Define functions for calculating weighted mean and proportions<a class="headerlink" href="#define-functions-for-calculating-weighted-mean-and-proportions" title="Permalink to this heading">#</a></h3>
<p>Group data by specified geography (e.g. closest IVT unit) and calculate the weighted average of specified columns - <a class="reference external" href="https://stackoverflow.com/questions/31521027/groupby-weighted-average-and-sum-in-pandas-dataframe">see stackoverflow tutorial here</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">weighted_av</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">group_by</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">new_col</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;population_all&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Groupby specified column and then find weighted average of another column</span>
<span class="sd">    Returns normal mean and weighted mean</span>
<span class="sd">    Inputs:</span>
<span class="sd">    - df - dataframe, contains data and columns to do calculation</span>
<span class="sd">    - group_by - string, column to group by</span>
<span class="sd">    - col - string, column to find average of</span>
<span class="sd">    - new_col - string, name of column which will contain weighted mean</span>
<span class="sd">    - weight - string, name of column to weight by, default &#39;population_all&#39;</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">res</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span>
           <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">group_by</span><span class="p">)</span>
           <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">col</span><span class="p">]),</span>
                                       <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">weights</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">weight</span><span class="p">])],</span>
                                      <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">new_col</span><span class="p">])))</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Group data by specific geography (e.g. ambulance trust) and calculate proportion.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">find_proportion</span><span class="p">(</span><span class="n">subgroup_col</span><span class="p">,</span> <span class="n">overall_col</span><span class="p">,</span> <span class="n">proportion_col</span><span class="p">,</span> <span class="n">group_col</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Groupby a particular geography, and find a proportion from two provided</span>
<span class="sd">    columns</span>
<span class="sd">    Inputs:</span>
<span class="sd">    subgroup_col - string, numerator, has population counts for a subgroup</span>
<span class="sd">    overall_col - string, denominator, has population count overall</span>
<span class="sd">    proportion_col - string, name for the column produced</span>
<span class="sd">    group_col - string, column to groupby when calculate proportions</span>
<span class="sd">    df - dataframe, with columns used above</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1"># Sum the columns for each group</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">group_col</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">({</span>
        <span class="n">subgroup_col</span><span class="p">:</span> <span class="s1">&#39;sum&#39;</span><span class="p">,</span>
        <span class="n">overall_col</span><span class="p">:</span> <span class="s1">&#39;sum&#39;</span>
    <span class="p">})</span>

    <span class="c1"># Find the proportions for each group</span>
    <span class="n">res</span><span class="p">[</span><span class="n">proportion_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="n">subgroup_col</span><span class="p">]</span> <span class="o">/</span> <span class="n">res</span><span class="p">[</span><span class="n">overall_col</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">res</span>
</pre></div>
</div>
</div>
</div>
<p>Find counts of people in each category, then calculate proportion.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">find_count_and_proportion</span><span class="p">(</span><span class="n">df_lsoa</span><span class="p">,</span> <span class="n">area</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">prop</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Finds count of people in each category for each area (based on LSOA info</span>
<span class="sd">    and counts), and then calculates proportion in particular category.</span>
<span class="sd">    Requires col to contain &#39;True&#39; &#39;False&#39; where &#39;True&#39; is the proportion you</span>
<span class="sd">    want to find (so calculates &#39;True&#39; / &#39;True&#39;+&#39;False&#39;)</span>
<span class="sd">    Inputs:</span>
<span class="sd">    - df_lsoa - dataframe with information on each LSOA</span>
<span class="sd">    - area - string, column to group areas by</span>
<span class="sd">    - col - string, column with data of interest</span>
<span class="sd">    - count - string, column with population count</span>
<span class="sd">    - prop - string, name of new column with proportion</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1"># Find count for each area of people in each category</span>
    <span class="n">counts</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_lsoa</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">area</span><span class="p">,</span> <span class="n">col</span><span class="p">])[</span><span class="n">count</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>

    <span class="c1"># Reformat dataframe</span>
    <span class="n">counts</span> <span class="o">=</span> <span class="n">counts</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;n&#39;</span><span class="p">)</span>
    <span class="n">counts</span> <span class="o">=</span> <span class="n">counts</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span>
        <span class="n">index</span><span class="o">=</span><span class="n">area</span><span class="p">,</span>
        <span class="n">columns</span><span class="o">=</span><span class="n">col</span><span class="p">,</span>
        <span class="n">values</span><span class="o">=</span><span class="s1">&#39;n&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Set NaN to 0</span>
    <span class="n">counts</span> <span class="o">=</span> <span class="n">counts</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Find proportion</span>
    <span class="n">counts</span><span class="p">[</span><span class="n">prop</span><span class="p">]</span> <span class="o">=</span> <span class="n">counts</span><span class="p">[</span><span class="s1">&#39;True&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">counts</span><span class="p">[</span><span class="s1">&#39;True&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">counts</span><span class="p">[</span><span class="s1">&#39;False&#39;</span><span class="p">])</span>

    <span class="c1"># Set index to the area unit</span>
    <span class="n">counts</span> <span class="o">=</span> <span class="n">counts</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">area</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">counts</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="extract-boundaries">
<h3>1.4 Extract boundaries<a class="headerlink" href="#extract-boundaries" title="Permalink to this heading">#</a></h3>
<p>Extract the bounds of each IVT catchment.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">eng_wales_bounds</span> <span class="o">=</span> <span class="n">gdf_ivt_catchment</span><span class="o">.</span><span class="n">bounds</span>
<span class="n">eng_wales_bounds</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>minx</th>
      <th>miny</th>
      <th>maxx</th>
      <th>maxy</th>
    </tr>
    <tr>
      <th>closest_iv</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>B152TH</th>
      <td>-228159.802962</td>
      <td>6.840962e+06</td>
      <td>-186486.338536</td>
      <td>6.891587e+06</td>
    </tr>
    <tr>
      <th>B714HJ</th>
      <td>-230754.673759</td>
      <td>6.862190e+06</td>
      <td>-174024.968174</td>
      <td>6.926919e+06</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="define-mapping-functions">
<h3>1.5 Define mapping functions<a class="headerlink" href="#define-mapping-functions" title="Permalink to this heading">#</a></h3>
<p>Non-overlapping labels of each stroke unit - <a class="reference external" href="https://stackoverflow.com/questions/43916834/matplotlib-dynamically-change-text-position">see stackoverflow explanation here</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">add_nonoverlapping_text_labels</span><span class="p">(</span><span class="n">units</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">y_step</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">7</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Creates non-overlapping text labels for stroke units to the input axis</span>
<span class="sd">    Inputs:</span>
<span class="sd">    - units - dataframe, contains data on each hospital</span>
<span class="sd">    - ax - axis object, to add labels to</span>
<span class="sd">    - col - string, label for each position</span>
<span class="sd">    - y_step - number, amount to adjust position on y axis by</span>
<span class="sd">    - fontsize - number, size of font in labels</span>
<span class="sd">    Output:</span>
<span class="sd">    - ax - axis object with addition of text labels</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1"># Create empty array</span>
    <span class="n">text_rectangles</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Sort labels descending in y axis (gives better results)</span>
    <span class="n">units</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;sort_by&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">units</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">y</span>
    <span class="n">units</span> <span class="o">=</span> <span class="n">units</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;sort_by&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">units</span><span class="p">[</span><span class="s1">&#39;sort_by&#39;</span><span class="p">]</span>

    <span class="c1"># Add labels to the plot</span>
    <span class="c1"># Loop through each stroke unit - in each loop, get x, y and label</span>
    <span class="n">geom_unit</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">units</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">units</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">units</span><span class="p">[</span><span class="n">col</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">geom_unit</span><span class="p">:</span>

        <span class="c1"># Add label to the axis (xy is location of point)</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
            <span class="n">text</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
            <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span>  <span class="c1"># location of point</span>
            <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span>  <span class="c1"># location of text that goes with point</span>
            <span class="n">textcoords</span><span class="o">=</span><span class="s1">&#39;offset points&#39;</span><span class="p">,</span>  <span class="c1"># offset text in points from xy value</span>
            <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span>
            <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span>
                      <span class="n">boxstyle</span><span class="o">=</span><span class="s2">&quot;round&quot;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.1</span><span class="p">))</span>

        <span class="n">rect</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">get_window_extent</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">other_rect</span> <span class="ow">in</span> <span class="n">text_rectangles</span><span class="p">:</span>
            <span class="k">while</span> <span class="n">Bbox</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">rect</span><span class="p">,</span> <span class="n">other_rect</span><span class="p">):</span>  <span class="c1"># overlapping</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">get_position</span><span class="p">()</span>
                <span class="n">text</span><span class="o">.</span><span class="n">set_position</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">y_step</span><span class="p">)))</span>
                <span class="n">rect</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">get_window_extent</span><span class="p">()</span>
        <span class="n">text_rectangles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rect</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">ax</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_map</span><span class="p">(</span><span class="n">gdf</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">col_readable</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">include_legend</span><span class="p">,</span> <span class="n">legend_kwds</span><span class="p">,</span>
             <span class="n">units</span><span class="p">,</span> <span class="n">base_map</span><span class="p">,</span> <span class="n">show_labels</span><span class="p">,</span> <span class="n">cmap</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Create map of catchment areas, coloured by the provided column.</span>
<span class="sd">    Inputs:</span>
<span class="sd">    - gdf - geopandas dataframe with IVT catchment areas and col</span>
<span class="sd">    - col - string, column to colour map by</span>
<span class="sd">    - col_readable - string, column used to colour map</span>
<span class="sd">    - ax - axis object, to plot map on</span>
<span class="sd">    - include_legend - boolean, whether to display legend</span>
<span class="sd">    - legend_kwds - dictionary, characteristics of legend</span>
<span class="sd">    - units - dataframe, information on each stroke unit inc. location</span>
<span class="sd">    - base_map - boolean, whether to add base map</span>
<span class="sd">    - show_labels - boolean, whether to add hospital labels</span>
<span class="sd">    - cmap - string, colourmap to use</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1"># Plot IVT catchment areas</span>
    <span class="n">gdf</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
        <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
        <span class="n">column</span><span class="o">=</span><span class="n">col</span><span class="p">,</span>  <span class="c1"># Column to apply colour</span>
        <span class="n">antialiased</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="c1"># Avoids artifact boundry lines</span>
        <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;face&#39;</span><span class="p">,</span>  <span class="c1"># Make LSOA boundry same colour as area</span>
        <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>  <span class="c1"># Use linewidth=0 to hide boarder lines</span>
        <span class="c1"># vmin=0,  # Manual scale min (remove to make automatic)</span>
        <span class="c1"># vmax=70,  # Manual scale max (remove to make automatic)</span>
        <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>  <span class="c1"># Colour map to use</span>
        <span class="n">legend</span><span class="o">=</span><span class="n">include_legend</span><span class="p">,</span>  <span class="c1"># Whether to display legend</span>
        <span class="n">legend_kwds</span><span class="o">=</span><span class="n">legend_kwds</span><span class="p">,</span>  <span class="c1"># Characteristics of legend</span>
        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>  <span class="c1"># Set transparency (to reveal basemap)</span>

    <span class="c1"># Add title if categorical (for numeric, it is done with legend_kwds)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_numeric_dtype</span><span class="p">(</span><span class="n">gdf</span><span class="p">[</span><span class="n">col</span><span class="p">])</span> <span class="ow">and</span> <span class="n">include_legend</span><span class="p">:</span>
        <span class="n">leg</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_legend</span><span class="p">()</span>
        <span class="n">leg</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">col_readable</span><span class="p">)</span>

    <span class="c1"># Add country border</span>
    <span class="n">outline</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>

    <span class="c1"># Add location of hospitals and - if True - labels for each hospital</span>
    <span class="n">units</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">120</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">show_labels</span><span class="p">:</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">add_nonoverlapping_text_labels</span><span class="p">(</span>
            <span class="n">units</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="s1">&#39;hospital_city&#39;</span><span class="p">,</span> <span class="n">y_step</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>

    <span class="c1"># If True, add base map, specifying same CRS and using manual zoom to</span>
    <span class="c1"># adjust level of detail</span>
    <span class="k">if</span> <span class="n">base_map</span><span class="p">:</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">add_basemap</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">ctx</span><span class="o">.</span><span class="n">providers</span><span class="o">.</span><span class="n">OpenStreetMap</span><span class="o">.</span><span class="n">Mapnik</span><span class="p">,</span> <span class="n">zoom</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

    <span class="c1"># Remove x and y ticks</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Turn off axis line and numbers</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">create_map</span><span class="p">(</span><span class="n">gdf</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">col_readable</span><span class="p">,</span> <span class="n">gdf_units</span><span class="p">,</span>
               <span class="n">base_map</span><span class="p">,</span> <span class="n">show_labels</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;inferno_r&#39;</span><span class="p">,</span> <span class="n">include_legend</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Creates map of England and Wales, with an inset map of London. Shows</span>
<span class="sd">    IVT catchment areas, coloured by value from specified column. Uses the</span>
<span class="sd">    plot_map() function to create each map (main and inset).</span>
<span class="sd">    Inputs:</span>
<span class="sd">    - gdf - geopandas dataframe with polygons and col</span>
<span class="sd">    - col - string, column to colour map by</span>
<span class="sd">    - col_readable - string, used for legend and plot title</span>
<span class="sd">    - gdf_units - dataframe, information on each stroke unit inc. location</span>
<span class="sd">    - base_map - boolean, whether to add base map</span>
<span class="sd">    - cmap - string, colourmap to use on maps, default &#39;inferno_r&#39;</span>
<span class="sd">    - include_legend - boolean, whether to include a legend, default True</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1"># Set up figure with max dimensions of 10x10 inch</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">))</span>

    <span class="c1"># Set legend kwds if is numeric, else blank</span>
    <span class="k">if</span> <span class="n">is_numeric_dtype</span><span class="p">(</span><span class="n">gdf</span><span class="p">[</span><span class="n">col</span><span class="p">]):</span>
        <span class="n">legend_kwds</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;shrink&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">col_readable</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">legend_kwds</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Plot map for England and Wales</span>
    <span class="n">plot_map</span><span class="p">(</span><span class="n">gdf</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">col_readable</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span>
             <span class="n">include_legend</span><span class="o">=</span><span class="n">include_legend</span><span class="p">,</span>
             <span class="n">legend_kwds</span><span class="o">=</span><span class="n">legend_kwds</span><span class="p">,</span>
             <span class="n">units</span><span class="o">=</span><span class="n">gdf_units</span><span class="p">,</span>
             <span class="n">base_map</span><span class="o">=</span><span class="n">base_map</span><span class="p">,</span>
             <span class="n">show_labels</span><span class="o">=</span><span class="n">show_labels</span><span class="p">,</span>
             <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>

    <span class="c1"># Make space at bottom for inset map of London</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">100000</span><span class="p">,</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>

    <span class="c1"># Make space on right for hospital name label</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">50000</span><span class="p">)</span>

    <span class="c1"># Create inset axis in bottom right corner</span>
    <span class="n">axins</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">inset_axes</span><span class="p">([</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.18</span><span class="p">,</span> <span class="mf">0.18</span><span class="p">])</span>

    <span class="c1"># Identify London hospitals to go in the inset map</span>
    <span class="n">london_mask</span> <span class="o">=</span> <span class="n">gdf_units</span><span class="p">[</span><span class="s2">&quot;Strategic Clinical Network&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;London SCN&quot;</span>
    <span class="n">london_hospitals</span> <span class="o">=</span> <span class="n">gdf_units</span><span class="p">[</span><span class="s2">&quot;Hospital_name&quot;</span><span class="p">][</span><span class="n">london_mask</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
    <span class="n">london_units</span> <span class="o">=</span> <span class="n">gdf_units</span><span class="p">[</span><span class="n">london_mask</span><span class="p">]</span>

    <span class="c1"># Identify map area to plot in the inset map</span>
    <span class="c1"># initialise exteme values</span>
    <span class="n">minx_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
    <span class="n">miny_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
    <span class="n">maxx_</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">maxy_</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1"># Find min and max x and y for the london hospitals</span>
    <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">london_hospitals</span><span class="p">:</span>
        <span class="n">minx</span><span class="p">,</span> <span class="n">miny</span><span class="p">,</span> <span class="n">maxx</span><span class="p">,</span> <span class="n">maxy</span> <span class="o">=</span> <span class="n">eng_wales_bounds</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">h</span><span class="p">]</span>
        <span class="n">minx_</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">minx_</span><span class="p">,</span> <span class="n">minx</span><span class="p">)</span>
        <span class="n">miny_</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">miny_</span><span class="p">,</span> <span class="n">miny</span><span class="p">)</span>
        <span class="n">maxx_</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">maxx_</span><span class="p">,</span> <span class="n">maxx</span><span class="p">)</span>
        <span class="n">maxy_</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">maxy_</span><span class="p">,</span> <span class="n">maxy</span><span class="p">)</span>

    <span class="c1"># Set extent of inset map</span>
    <span class="n">axins</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">minx_</span><span class="p">,</span> <span class="n">maxx_</span><span class="p">)</span>
    <span class="n">axins</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">miny_</span><span class="p">,</span> <span class="n">maxy_</span><span class="p">)</span>

    <span class="c1"># Define lines connecting inset map to main map</span>
    <span class="n">mark_inset</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">axins</span><span class="p">,</span> <span class="n">loc1</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">loc2</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">fc</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="n">ec</span><span class="o">=</span><span class="s2">&quot;0.5&quot;</span><span class="p">)</span>

    <span class="c1"># Plot inset map of London</span>
    <span class="n">plot_map</span><span class="p">(</span><span class="n">gdf</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">col_readable</span><span class="p">,</span> <span class="n">axins</span><span class="p">,</span>
             <span class="n">include_legend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
             <span class="n">legend_kwds</span><span class="o">=</span><span class="p">{},</span>
             <span class="n">units</span><span class="o">=</span><span class="n">london_units</span><span class="p">,</span>
             <span class="n">base_map</span><span class="o">=</span><span class="n">base_map</span><span class="p">,</span>
             <span class="n">show_labels</span><span class="o">=</span><span class="n">show_labels</span><span class="p">,</span>
             <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>

    <span class="c1"># Set title</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">col_readable</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># Adjust for printing</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">margins</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">apply_aspect</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;figures/map_</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s1">.png&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="c1"># If colouring column is numeric, do some further analysis</span>
    <span class="k">if</span> <span class="n">is_numeric_dtype</span><span class="p">(</span><span class="n">gdf</span><span class="p">[</span><span class="n">col</span><span class="p">]):</span>
        <span class="c1"># Print information on the range and median</span>
        <span class="n">display</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Range: </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">gdf</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span><span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s1"> to &#39;</span> <span class="o">+</span>
                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">gdf</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span><span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">display</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Median: </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">gdf</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">(),</span><span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># Histogram showing range in that col</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">gdf</span><span class="p">[</span><span class="n">col</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">col_readable</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Number of catchment areas&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="ivt-catchment-statistics">
<h2>2 IVT catchment statistics<a class="headerlink" href="#ivt-catchment-statistics" title="Permalink to this heading">#</a></h2>
<section id="ivt-catchment-map">
<h3>IVT catchment map<a class="headerlink" href="#ivt-catchment-map" title="Permalink to this heading">#</a></h3>
<p>Information on using different colours for adjacent polygons <a class="reference external" href="https://pysal.org/mapclassify/notebooks/05_Greedy_coloring.html">available here</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Use greedy to assign colours wherein adjacent polygons are never the same</span>
<span class="c1"># min_distance is the minimal distance between colours</span>
<span class="c1"># balance=count means we try to balance number of features per colour</span>
<span class="n">gdf_ivt_catchment</span><span class="p">[</span><span class="s1">&#39;adjacent_colours&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">greedy</span><span class="p">(</span>
    <span class="n">gdf_ivt_catchment</span><span class="p">,</span> <span class="n">min_distance</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">balance</span><span class="o">=</span><span class="s1">&#39;count&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/home/amy/miniconda3/envs/geopandas/lib/python3.9/site-packages/libpysal/weights/util.py:1658: FutureWarning: The `query_bulk()` method is deprecated and will be removed in GeoPandas 1.0. You can use the `query()` method instead.
  inp, res = gdf.sindex.query_bulk(gdf.geometry, predicate=predicate)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create map</span>
<span class="n">create_map</span><span class="p">(</span>
    <span class="n">gdf</span><span class="o">=</span><span class="n">gdf_ivt_catchment</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(),</span>
    <span class="n">col</span><span class="o">=</span><span class="s1">&#39;adjacent_colours&#39;</span><span class="p">,</span>
    <span class="n">col_readable</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Map of catchment areas for each IVT unit</span><span class="se">\n</span><span class="s1">(based on &#39;</span> <span class="o">+</span>
                  <span class="s1">&#39;closest unit for each LSOA)&#39;</span><span class="p">),</span>
    <span class="n">gdf_units</span><span class="o">=</span><span class="n">gdf_units</span><span class="p">,</span>
    <span class="n">base_map</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">show_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span>
    <span class="n">include_legend</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/47808118a9dfa476032ba3bb4598dbe2d6d02b4e3b742e9533805c1bcdb9bfdd.png" src="_images/47808118a9dfa476032ba3bb4598dbe2d6d02b4e3b742e9533805c1bcdb9bfdd.png" />
</div>
</div>
</section>
<section id="admissions-to-each-unit-2021-22">
<h3>Admissions to each unit (2021-22)<a class="headerlink" href="#admissions-to-each-unit-2021-22" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get admissions to each unit from 2021/22</span>
<span class="n">admissions_2122</span> <span class="o">=</span> <span class="p">(</span><span class="n">gdf_units</span><span class="p">[[</span><span class="s1">&#39;Postcode&#39;</span><span class="p">,</span> <span class="s1">&#39;Admissions 21/22&#39;</span><span class="p">]]</span>
                   <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Postcode&#39;</span><span class="p">)</span>
                   <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Admissions 21/22&#39;</span><span class="p">:</span> <span class="s1">&#39;admissions_2122&#39;</span><span class="p">})</span>
                   <span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>
<span class="n">admissions_2122</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>admissions_2122</th>
    </tr>
    <tr>
      <th>Postcode</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>RM70AG</th>
      <td>981</td>
    </tr>
    <tr>
      <th>E11BB</th>
      <td>861</td>
    </tr>
    <tr>
      <th>SW66SX</th>
      <td>1147</td>
    </tr>
    <tr>
      <th>SE59RW</th>
      <td>824</td>
    </tr>
    <tr>
      <th>BR68ND</th>
      <td>847</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
    </tr>
    <tr>
      <th>SY231ER</th>
      <td>126</td>
    </tr>
    <tr>
      <th>SA148QF</th>
      <td>162</td>
    </tr>
    <tr>
      <th>SA312AF</th>
      <td>207</td>
    </tr>
    <tr>
      <th>SA612PZ</th>
      <td>208</td>
    </tr>
    <tr>
      <th>SA66NL</th>
      <td>615</td>
    </tr>
  </tbody>
</table>
<p>113 rows × 1 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Join with geopandas dataframe</span>
<span class="n">gdf_ivt_catchment</span> <span class="o">=</span> <span class="p">(</span><span class="n">gdf_ivt_catchment</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">admissions_2122</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create map</span>
<span class="n">create_map</span><span class="p">(</span><span class="n">gdf</span><span class="o">=</span><span class="n">gdf_ivt_catchment</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(),</span>
           <span class="n">col</span><span class="o">=</span><span class="s1">&#39;admissions_2122&#39;</span><span class="p">,</span>
           <span class="n">col_readable</span><span class="o">=</span><span class="s1">&#39;Admissions to each unit (21/22)&#39;</span><span class="p">,</span>
           <span class="n">gdf_units</span><span class="o">=</span><span class="n">gdf_units</span><span class="p">,</span>
           <span class="n">base_map</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
           <span class="n">show_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
           <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Reds&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/74bb80de4b5675e9f9c8aae04472023b5a1627d42bc5769e1ee853682da28865.png" src="_images/74bb80de4b5675e9f9c8aae04472023b5a1627d42bc5769e1ee853682da28865.png" />
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;Range: 126 to 1848&#39;
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;Median: 702.0&#39;
</pre></div>
</div>
<img alt="_images/89e71d7ff64e91a8d2c78a8d53d2cf44609cc380049af1f007271691fe9fccd0.png" src="_images/89e71d7ff64e91a8d2c78a8d53d2cf44609cc380049af1f007271691fe9fccd0.png" />
</div>
</div>
</section>
<section id="population-weighted-mean-income-domain-score-by-ivt-catchment">
<h3>Population-weighted mean income domain score by IVT catchment<a class="headerlink" href="#population-weighted-mean-income-domain-score-by-ivt-catchment" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Weighted mean income domain score by closest IVT unit</span>
<span class="n">df_ivt_ids</span> <span class="o">=</span> <span class="n">weighted_av</span><span class="p">(</span>
    <span class="n">df_lsoa</span><span class="p">,</span> <span class="n">group_by</span><span class="o">=</span><span class="s1">&#39;closest_ivt_unit&#39;</span><span class="p">,</span>
    <span class="n">col</span><span class="o">=</span><span class="s1">&#39;income_domain_score&#39;</span><span class="p">,</span> <span class="n">new_col</span><span class="o">=</span><span class="s1">&#39;income_domain_weighted_mean&#39;</span><span class="p">)</span>
<span class="n">df_ivt_ids</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>income_domain_weighted_mean</th>
    </tr>
    <tr>
      <th>closest_ivt_unit</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>B152TH</th>
      <td>0.180572</td>
      <td>0.182951</td>
    </tr>
    <tr>
      <th>B714HJ</th>
      <td>0.195096</td>
      <td>0.202612</td>
    </tr>
    <tr>
      <th>BA13NG</th>
      <td>0.083828</td>
      <td>0.083469</td>
    </tr>
    <tr>
      <th>BA214AT</th>
      <td>0.096528</td>
      <td>0.095511</td>
    </tr>
    <tr>
      <th>BB23HH</th>
      <td>0.172242</td>
      <td>0.177377</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>WD180HB</th>
      <td>0.079041</td>
      <td>0.080071</td>
    </tr>
    <tr>
      <th>WF14DG</th>
      <td>0.148147</td>
      <td>0.148666</td>
    </tr>
    <tr>
      <th>WR51DD</th>
      <td>0.095798</td>
      <td>0.093969</td>
    </tr>
    <tr>
      <th>WV100QP</th>
      <td>0.168500</td>
      <td>0.172614</td>
    </tr>
    <tr>
      <th>YO318HE</th>
      <td>0.085214</td>
      <td>0.084118</td>
    </tr>
  </tbody>
</table>
<p>113 rows × 2 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Add mean IoD to geopandas dataframe</span>
<span class="n">gdf_ivt_catchment</span> <span class="o">=</span> <span class="p">(</span><span class="n">gdf_ivt_catchment</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
    <span class="n">df_ivt_ids</span><span class="p">[</span><span class="s1">&#39;income_domain_weighted_mean&#39;</span><span class="p">]))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create map</span>
<span class="n">create_map</span><span class="p">(</span><span class="n">gdf</span><span class="o">=</span><span class="n">gdf_ivt_catchment</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(),</span>
           <span class="n">col</span><span class="o">=</span><span class="s1">&#39;income_domain_weighted_mean&#39;</span><span class="p">,</span>
           <span class="n">col_readable</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Population weighted mean income deprivation domain &#39;</span> <span class="o">+</span>
                         <span class="s1">&#39;score</span><span class="se">\n</span><span class="s1">(higher score indicates more deprivation) &#39;</span> <span class="o">+</span>
                         <span class="s1">&#39;(2019)&#39;</span><span class="p">),</span>
           <span class="n">gdf_units</span><span class="o">=</span><span class="n">gdf_units</span><span class="p">,</span>
           <span class="n">base_map</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
           <span class="n">show_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
           <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Reds&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/ae55c841b25a789b48e9481a8855e5b43734f666cdbba1aba05e237d61541fc4.png" src="_images/ae55c841b25a789b48e9481a8855e5b43734f666cdbba1aba05e237d61541fc4.png" />
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;Range: 0.058 to 0.209&#39;
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;Median: 0.122&#39;
</pre></div>
</div>
<img alt="_images/12e75c61e2c8fee562ff6fa0f6496b2b2929f94e54e69321bc57113e522f376c.png" src="_images/12e75c61e2c8fee562ff6fa0f6496b2b2929f94e54e69321bc57113e522f376c.png" />
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>4:80: E501 line too long (80 &gt; 79 characters)
</pre></div>
</div>
</div>
</div>
</section>
<section id="population-weighted-mean-imd-score-by-ivt-catchment">
<h3>Population-weighted mean IMD score by IVT catchment<a class="headerlink" href="#population-weighted-mean-imd-score-by-ivt-catchment" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Weighted mean IMD by closest IVT unit</span>
<span class="n">df_ivt_imd</span> <span class="o">=</span> <span class="n">weighted_av</span><span class="p">(</span>
    <span class="n">df_lsoa</span><span class="p">,</span> <span class="n">group_by</span><span class="o">=</span><span class="s1">&#39;closest_ivt_unit&#39;</span><span class="p">,</span>
    <span class="n">col</span><span class="o">=</span><span class="s1">&#39;imd_2019_score&#39;</span><span class="p">,</span> <span class="n">new_col</span><span class="o">=</span><span class="s1">&#39;imd_weighted_mean&#39;</span><span class="p">)</span>
<span class="n">df_ivt_imd</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>imd_weighted_mean</th>
    </tr>
    <tr>
      <th>closest_ivt_unit</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>B152TH</th>
      <td>31.070594</td>
      <td>31.488294</td>
    </tr>
    <tr>
      <th>B714HJ</th>
      <td>32.588740</td>
      <td>33.655519</td>
    </tr>
    <tr>
      <th>BA13NG</th>
      <td>13.353572</td>
      <td>13.335982</td>
    </tr>
    <tr>
      <th>BA214AT</th>
      <td>16.946994</td>
      <td>16.858199</td>
    </tr>
    <tr>
      <th>BB23HH</th>
      <td>31.070595</td>
      <td>31.789134</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>WD180HB</th>
      <td>12.004248</td>
      <td>12.153052</td>
    </tr>
    <tr>
      <th>WF14DG</th>
      <td>26.534618</td>
      <td>26.646876</td>
    </tr>
    <tr>
      <th>WR51DD</th>
      <td>16.780844</td>
      <td>16.451837</td>
    </tr>
    <tr>
      <th>WV100QP</th>
      <td>26.119438</td>
      <td>26.753959</td>
    </tr>
    <tr>
      <th>YO318HE</th>
      <td>14.738411</td>
      <td>14.606578</td>
    </tr>
  </tbody>
</table>
<p>113 rows × 2 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Add mean IMD to geopandas dataframe</span>
<span class="n">gdf_ivt_catchment</span> <span class="o">=</span> <span class="p">(</span><span class="n">gdf_ivt_catchment</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
    <span class="n">df_ivt_imd</span><span class="p">[</span><span class="s1">&#39;imd_weighted_mean&#39;</span><span class="p">]))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create map</span>
<span class="n">create_map</span><span class="p">(</span>
    <span class="n">gdf</span><span class="o">=</span><span class="n">gdf_ivt_catchment</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(),</span>
    <span class="n">col</span><span class="o">=</span><span class="s1">&#39;imd_weighted_mean&#39;</span><span class="p">,</span>
    <span class="n">col_readable</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Population weighted mean Index of Multiple Deprivation &#39;</span> <span class="o">+</span>
                  <span class="s1">&#39;(IMD) score</span><span class="se">\n</span><span class="s1">(higher score indicates more deprived area) &#39;</span> <span class="o">+</span>
                  <span class="s1">&#39;(IMD 2019)&#39;</span><span class="p">),</span>
    <span class="n">gdf_units</span><span class="o">=</span><span class="n">gdf_units</span><span class="p">,</span>
    <span class="n">base_map</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">show_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Reds&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/bb3645cadf88431d29007f4551451b5df4cc3fdfffa61e0e494e4b647accc5a0.png" src="_images/bb3645cadf88431d29007f4551451b5df4cc3fdfffa61e0e494e4b647accc5a0.png" />
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;Range: 10.093 to 36.601&#39;
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;Median: 20.032&#39;
</pre></div>
</div>
<img alt="_images/5627c2daa00773eb02e500e7ef6d245d2e0651bd92070a0dd9f03447837f5a75.png" src="_images/5627c2daa00773eb02e500e7ef6d245d2e0651bd92070a0dd9f03447837f5a75.png" />
</div>
</div>
</section>
<section id="ivt-catchment-size">
<h3>IVT catchment size<a class="headerlink" href="#ivt-catchment-size" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Calculate populations</span>
<span class="n">pop</span> <span class="o">=</span> <span class="n">df_lsoa</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;closest_ivt_unit&#39;</span><span class="p">)[</span><span class="s1">&#39;population_all&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

<span class="c1"># Print the range in population size of each catchment area</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The range of people across the </span><span class="si">{</span><span class="n">pop</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1"> catchments is: &#39;</span> <span class="o">+</span>
      <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">pop</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s1"> to &#39;</span> <span class="o">+</span>
      <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">pop</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="c1"># Print the median population size</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Median number of people: </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">pop</span><span class="o">.</span><span class="n">median</span><span class="p">(),</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="c1"># Create histogram to show distribution in population size of catchment areas</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">pop</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;IVT catchment population size&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Number of catchment areas&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The range of people across the 113 catchments is: 87086 to 1479138
Median number of people: 483031.0
</pre></div>
</div>
<img alt="_images/351f3009afcc2330d9e0bdb44873ab52f70f46dd97bbfe5d386031781b3163fa.png" src="_images/351f3009afcc2330d9e0bdb44873ab52f70f46dd97bbfe5d386031781b3163fa.png" />
</div>
</div>
</section>
<section id="ethnicity-proportion-ethnic-minority-by-ivt-catchment">
<h3>Ethnicity - proportion ethnic minority by IVT catchment<a class="headerlink" href="#ethnicity-proportion-ethnic-minority-by-ivt-catchment" title="Permalink to this heading">#</a></h3>
<p><a class="reference external" href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC9891657/">Fluck et al. 2023</a> Nature publication using SSNAP data to compare stroke outcomes in caucasion population versus ethnic minorities, finding people from ethnic minorities have earlier onset and more adverse outcomes.</p>
<p>In the maps, I have present the proportion of people in each IVT catchment area who are an ethnic minorities (language as per <a class="reference external" href="https://www.ethnicity-facts-figures.service.gov.uk/style-guide/writing-about-ethnicity">government recommendations</a>).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Show the ethnic groups</span>
<span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df_lsoa</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;ethnic_group&#39;</span><span class="p">)]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;ethnic_group_all_categories_ethnic_group&#39;,
 &#39;ethnic_group_white_total&#39;,
 &#39;ethnic_group_white_english_welsh_scottish_northern_irish_british&#39;,
 &#39;ethnic_group_white_irish&#39;,
 &#39;ethnic_group_white_gypsy_or_irish_traveller&#39;,
 &#39;ethnic_group_white_other_white&#39;,
 &#39;ethnic_group_mixed_multiple_ethnic_group_total&#39;,
 &#39;ethnic_group_mixed_multiple_ethnic_group_white_and_black_caribbean&#39;,
 &#39;ethnic_group_mixed_multiple_ethnic_group_white_and_black_african&#39;,
 &#39;ethnic_group_mixed_multiple_ethnic_group_white_and_asian&#39;,
 &#39;ethnic_group_mixed_multiple_ethnic_group_other_mixed&#39;,
 &#39;ethnic_group_asian_asian_british_total&#39;,
 &#39;ethnic_group_asian_asian_british_indian&#39;,
 &#39;ethnic_group_asian_asian_british_pakistani&#39;,
 &#39;ethnic_group_asian_asian_british_bangladeshi&#39;,
 &#39;ethnic_group_asian_asian_british_chinese&#39;,
 &#39;ethnic_group_asian_asian_british_other_asian&#39;,
 &#39;ethnic_group_black_african_caribbean_black_british_total&#39;,
 &#39;ethnic_group_black_african_caribbean_black_british_african&#39;,
 &#39;ethnic_group_black_african_caribbean_black_british_caribbean&#39;,
 &#39;ethnic_group_black_african_caribbean_black_british_other_black&#39;,
 &#39;ethnic_group_other_ethnic_group_total&#39;,
 &#39;ethnic_group_other_ethnic_group_arab&#39;,
 &#39;ethnic_group_other_ethnic_group_any_other_ethnic_group&#39;]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Add count of non-white (combines mixed, asian, black + other categories)</span>
<span class="n">df_lsoa</span><span class="p">[</span><span class="s1">&#39;ethnic_group_not_white&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">df_lsoa</span><span class="p">[</span><span class="s1">&#39;ethnic_group_all_categories_ethnic_group&#39;</span><span class="p">]</span> <span class="o">-</span>
    <span class="n">df_lsoa</span><span class="p">[</span><span class="s1">&#39;ethnic_group_white_total&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Find proportion with bad or very bad general health by IVT catchment</span>
<span class="n">ethnicity</span> <span class="o">=</span> <span class="n">find_proportion</span><span class="p">(</span>
    <span class="n">subgroup_col</span><span class="o">=</span><span class="s1">&#39;ethnic_group_not_white&#39;</span><span class="p">,</span>
    <span class="n">overall_col</span><span class="o">=</span><span class="s1">&#39;ethnic_group_all_categories_ethnic_group&#39;</span><span class="p">,</span>
    <span class="n">proportion_col</span><span class="o">=</span><span class="s1">&#39;ethnic_minority_proportion&#39;</span><span class="p">,</span>
    <span class="n">group_col</span><span class="o">=</span><span class="s1">&#39;closest_ivt_unit&#39;</span><span class="p">,</span>
    <span class="n">df</span><span class="o">=</span><span class="n">df_lsoa</span>
<span class="p">)</span>

<span class="n">ethnicity</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ethnic_group_not_white</th>
      <th>ethnic_group_all_categories_ethnic_group</th>
      <th>ethnic_minority_proportion</th>
    </tr>
    <tr>
      <th>closest_ivt_unit</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>B152TH</th>
      <td>296338</td>
      <td>906743</td>
      <td>0.326816</td>
    </tr>
    <tr>
      <th>B714HJ</th>
      <td>307488</td>
      <td>958616</td>
      <td>0.320762</td>
    </tr>
    <tr>
      <th>BA13NG</th>
      <td>17349</td>
      <td>448923</td>
      <td>0.038646</td>
    </tr>
    <tr>
      <th>BA214AT</th>
      <td>5261</td>
      <td>261069</td>
      <td>0.020152</td>
    </tr>
    <tr>
      <th>BB23HH</th>
      <td>86542</td>
      <td>473321</td>
      <td>0.182840</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Add proportion to geopandas dataframe</span>
<span class="n">gdf_ivt_catchment</span> <span class="o">=</span> <span class="p">(</span><span class="n">gdf_ivt_catchment</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
    <span class="n">ethnicity</span><span class="p">[</span><span class="s1">&#39;ethnic_minority_proportion&#39;</span><span class="p">]))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create map</span>
<span class="n">create_map</span><span class="p">(</span>
    <span class="n">gdf</span><span class="o">=</span><span class="n">gdf_ivt_catchment</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(),</span>
    <span class="n">col</span><span class="o">=</span><span class="s1">&#39;ethnic_minority_proportion&#39;</span><span class="p">,</span>
    <span class="n">col_readable</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Proportion of people who are an ethnic minority &#39;</span> <span class="o">+</span>
                  <span class="s1">&#39;(2011 census)&#39;</span><span class="p">),</span>
    <span class="n">gdf_units</span><span class="o">=</span><span class="n">gdf_units</span><span class="p">,</span>
    <span class="n">base_map</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">show_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Reds&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/5b32db56f1717cfa454704a57e7f52b00a9c712d9ec9a1f031adeaf2947e4793.png" src="_images/5b32db56f1717cfa454704a57e7f52b00a9c712d9ec9a1f031adeaf2947e4793.png" />
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;Range: 0.015 to 0.53&#39;
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;Median: 0.05&#39;
</pre></div>
</div>
<img alt="_images/ad007182bdbd1c0f1d8fec6a05b9baaecf4c18388494a0d529330787886acdf4.png" src="_images/ad007182bdbd1c0f1d8fec6a05b9baaecf4c18388494a0d529330787886acdf4.png" />
</div>
</div>
</section>
<section id="general-health-proportion-with-bad-very-bad-health-by-ivt-catchment">
<h3>General health - proportion with bad/very bad health by IVT catchment<a class="headerlink" href="#general-health-proportion-with-bad-very-bad-health-by-ivt-catchment" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Find proportion with bad or very bad general health by IVT catchment</span>
<span class="n">bad_health</span> <span class="o">=</span> <span class="n">find_proportion</span><span class="p">(</span>
    <span class="n">subgroup_col</span><span class="o">=</span><span class="s1">&#39;bad_or_very_bad_health&#39;</span><span class="p">,</span>
    <span class="n">overall_col</span><span class="o">=</span><span class="s1">&#39;all_categories_general_health&#39;</span><span class="p">,</span>
    <span class="n">proportion_col</span><span class="o">=</span><span class="s1">&#39;bad_health_proportion&#39;</span><span class="p">,</span>
    <span class="n">group_col</span><span class="o">=</span><span class="s1">&#39;closest_ivt_unit&#39;</span><span class="p">,</span>
    <span class="n">df</span><span class="o">=</span><span class="n">df_lsoa</span>
<span class="p">)</span>

<span class="n">bad_health</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>bad_or_very_bad_health</th>
      <th>all_categories_general_health</th>
      <th>bad_health_proportion</th>
    </tr>
    <tr>
      <th>closest_ivt_unit</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>B152TH</th>
      <td>55724</td>
      <td>906743</td>
      <td>0.061455</td>
    </tr>
    <tr>
      <th>B714HJ</th>
      <td>65605</td>
      <td>958616</td>
      <td>0.068437</td>
    </tr>
    <tr>
      <th>BA13NG</th>
      <td>19467</td>
      <td>448923</td>
      <td>0.043364</td>
    </tr>
    <tr>
      <th>BA214AT</th>
      <td>12458</td>
      <td>261069</td>
      <td>0.047719</td>
    </tr>
    <tr>
      <th>BB23HH</th>
      <td>32885</td>
      <td>473321</td>
      <td>0.069477</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Add proportion to geopandas dataframe</span>
<span class="n">gdf_ivt_catchment</span> <span class="o">=</span> <span class="p">(</span><span class="n">gdf_ivt_catchment</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
    <span class="n">bad_health</span><span class="p">[</span><span class="s1">&#39;bad_health_proportion&#39;</span><span class="p">]))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create map</span>
<span class="n">create_map</span><span class="p">(</span>
    <span class="n">gdf</span><span class="o">=</span><span class="n">gdf_ivt_catchment</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(),</span>
    <span class="n">col</span><span class="o">=</span><span class="s1">&#39;bad_health_proportion&#39;</span><span class="p">,</span>
    <span class="n">col_readable</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Proportion of people with bad or very bad general health &#39;</span> <span class="o">+</span>
                  <span class="s1">&#39;(2011 census)&#39;</span><span class="p">),</span>
    <span class="n">gdf_units</span><span class="o">=</span><span class="n">gdf_units</span><span class="p">,</span>
    <span class="n">base_map</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">show_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Reds&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/c6025d0ba2b0ca97ac8c60a2f1594a6ac7f8b4dbc37729736366e57d34d023db.png" src="_images/c6025d0ba2b0ca97ac8c60a2f1594a6ac7f8b4dbc37729736366e57d34d023db.png" />
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;Range: 0.032 to 0.103&#39;
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;Median: 0.055&#39;
</pre></div>
</div>
<img alt="_images/081f614e2846f6ddc9de5f9e24c09d1049bb5ef85a320a86913cbdebba15248c.png" src="_images/081f614e2846f6ddc9de5f9e24c09d1049bb5ef85a320a86913cbdebba15248c.png" />
</div>
</div>
</section>
<section id="long-term-health-problem-or-disability-proportion-by-ivt-catchment">
<h3>Long-term health problem or disability - proportion by IVT catchment<a class="headerlink" href="#long-term-health-problem-or-disability-proportion-by-ivt-catchment" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Add column with count of long-term health problem (limited a little or alot)</span>
<span class="n">df_lsoa</span><span class="p">[</span><span class="s1">&#39;long_term_health_count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">df_lsoa</span><span class="p">[</span><span class="s1">&#39;all_categories_long_term_health_problem_or_disability&#39;</span><span class="p">]</span> <span class="o">-</span>
    <span class="n">df_lsoa</span><span class="p">[</span><span class="s1">&#39;day_to_day_activities_not_limited&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Find proportion with long-term health problem by IVT catchment</span>
<span class="n">long_term</span> <span class="o">=</span> <span class="n">find_proportion</span><span class="p">(</span>
    <span class="n">subgroup_col</span><span class="o">=</span><span class="s1">&#39;long_term_health_count&#39;</span><span class="p">,</span>
    <span class="n">overall_col</span><span class="o">=</span><span class="s1">&#39;all_categories_long_term_health_problem_or_disability&#39;</span><span class="p">,</span>
    <span class="n">proportion_col</span><span class="o">=</span><span class="s1">&#39;long_term_health_proportion&#39;</span><span class="p">,</span>
    <span class="n">group_col</span><span class="o">=</span><span class="s1">&#39;closest_ivt_unit&#39;</span><span class="p">,</span>
    <span class="n">df</span><span class="o">=</span><span class="n">df_lsoa</span>
<span class="p">)</span>

<span class="n">long_term</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>long_term_health_count</th>
      <th>all_categories_long_term_health_problem_or_disability</th>
      <th>long_term_health_proportion</th>
    </tr>
    <tr>
      <th>closest_ivt_unit</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>B152TH</th>
      <td>157057</td>
      <td>889227</td>
      <td>0.176622</td>
    </tr>
    <tr>
      <th>B714HJ</th>
      <td>180021</td>
      <td>947524</td>
      <td>0.189991</td>
    </tr>
    <tr>
      <th>BA13NG</th>
      <td>70366</td>
      <td>438597</td>
      <td>0.160434</td>
    </tr>
    <tr>
      <th>BA214AT</th>
      <td>45407</td>
      <td>254179</td>
      <td>0.178642</td>
    </tr>
    <tr>
      <th>BB23HH</th>
      <td>93679</td>
      <td>468472</td>
      <td>0.199967</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Add proportion to geopandas dataframe</span>
<span class="n">gdf_ivt_catchment</span> <span class="o">=</span> <span class="p">(</span><span class="n">gdf_ivt_catchment</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
    <span class="n">long_term</span><span class="p">[</span><span class="s1">&#39;long_term_health_proportion&#39;</span><span class="p">]))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create map</span>
<span class="n">create_map</span><span class="p">(</span>
    <span class="n">gdf</span><span class="o">=</span><span class="n">gdf_ivt_catchment</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(),</span>
    <span class="n">col</span><span class="o">=</span><span class="s1">&#39;long_term_health_proportion&#39;</span><span class="p">,</span>
    <span class="n">col_readable</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Proportion of people with long-term health problem or &#39;</span> <span class="o">+</span>
                  <span class="s1">&#39;disability</span><span class="se">\n</span><span class="s1">(which limits day-to-day activities a &#39;</span> <span class="o">+</span>
                  <span class="s1">&#39;little or a lot) (2011 census)&#39;</span><span class="p">),</span>
    <span class="n">gdf_units</span><span class="o">=</span><span class="n">gdf_units</span><span class="p">,</span>
    <span class="n">base_map</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">show_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Reds&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/0dfa7cc8df6f39c42c9046f02c85220a85e14bb6e2ee5f17452a4b8ef1080191.png" src="_images/0dfa7cc8df6f39c42c9046f02c85220a85e14bb6e2ee5f17452a4b8ef1080191.png" />
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;Range: 0.115 to 0.262&#39;
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;Median: 0.182&#39;
</pre></div>
</div>
<img alt="_images/629b55eac41dbe34f96168a094ddbfc7deeba02950ef7e5fff7496fc9a8b29fb.png" src="_images/629b55eac41dbe34f96168a094ddbfc7deeba02950ef7e5fff7496fc9a8b29fb.png" />
</div>
</div>
</section>
<section id="rural-urban-proportion-of-people-living-in-rural-areas-by-ivt-catchment">
<h3>Rural/urban - proportion of people living in rural areas by IVT catchment<a class="headerlink" href="#rural-urban-proportion-of-people-living-in-rural-areas-by-ivt-catchment" title="Permalink to this heading">#</a></h3>
<p>The LSOA rural/urban classification had 8 categories. The local authority rural urban classification is based on the percentage of residents living in rural areas (and then has 6 classes). Hence, for each IVT catchment, I have presented the percentage of residents living in rural areas.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_lsoa</span><span class="p">[</span><span class="s1">&#39;rural_urban_2011&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>rural_urban_2011
Urban city and town                                15724
Urban major conurbation                            11523
Rural town and fringe                               3189
Rural village and dispersed                         2490
Urban minor conurbation                             1208
Rural village and dispersed in a sparse setting      327
Rural town and fringe in a sparse setting            197
Urban city and town in a sparse setting               94
Name: count, dtype: int64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Extract if is rural or if is urban (each classification starts with that)</span>
<span class="n">df_lsoa</span><span class="p">[</span><span class="s1">&#39;ruc_overall&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_lsoa</span><span class="p">[</span><span class="s1">&#39;rural_urban_2011&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span>

<span class="c1"># Add column where True if rural</span>
<span class="n">df_lsoa</span><span class="p">[</span><span class="s1">&#39;rural&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_lsoa</span><span class="p">[</span><span class="s1">&#39;ruc_overall&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Rural&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">({</span>
    <span class="kc">True</span><span class="p">:</span> <span class="s1">&#39;True&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">:</span> <span class="s1">&#39;False&#39;</span><span class="p">})</span>

<span class="c1"># Show columns</span>
<span class="n">df_lsoa</span><span class="p">[[</span><span class="s1">&#39;ruc_overall&#39;</span><span class="p">,</span> <span class="s1">&#39;rural&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>ruc_overall  rural
Urban        False    28549
Rural        True      6203
Name: count, dtype: int64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Find proportion people in rural LSOA for each IVT unit</span>
<span class="n">ruc</span> <span class="o">=</span> <span class="n">find_count_and_proportion</span><span class="p">(</span>
    <span class="n">df_lsoa</span><span class="o">=</span><span class="n">df_lsoa</span><span class="p">,</span>
    <span class="n">area</span><span class="o">=</span><span class="s1">&#39;closest_ivt_unit&#39;</span><span class="p">,</span>
    <span class="n">col</span><span class="o">=</span><span class="s1">&#39;rural&#39;</span><span class="p">,</span>
    <span class="n">count</span><span class="o">=</span><span class="s1">&#39;population_all&#39;</span><span class="p">,</span>
    <span class="n">prop</span><span class="o">=</span><span class="s1">&#39;proportion_rural&#39;</span>
<span class="p">)</span>

<span class="c1"># Preview dataframe</span>
<span class="n">ruc</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>False</th>
      <th>True</th>
      <th>proportion_rural</th>
    </tr>
    <tr>
      <th>closest_ivt_unit</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>B152TH</th>
      <td>926409.0</td>
      <td>36603.0</td>
      <td>0.038009</td>
    </tr>
    <tr>
      <th>B714HJ</th>
      <td>981575.0</td>
      <td>30814.0</td>
      <td>0.030437</td>
    </tr>
    <tr>
      <th>BA13NG</th>
      <td>365427.0</td>
      <td>117604.0</td>
      <td>0.243471</td>
    </tr>
    <tr>
      <th>BA214AT</th>
      <td>96824.0</td>
      <td>177608.0</td>
      <td>0.647184</td>
    </tr>
    <tr>
      <th>BB23HH</th>
      <td>422949.0</td>
      <td>63171.0</td>
      <td>0.129949</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Add proportion to geopandas dataframe</span>
<span class="n">gdf_ivt_catchment</span> <span class="o">=</span> <span class="p">(</span><span class="n">gdf_ivt_catchment</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
    <span class="n">ruc</span><span class="p">[</span><span class="s1">&#39;proportion_rural&#39;</span><span class="p">]))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create map</span>
<span class="n">create_map</span><span class="p">(</span>
    <span class="n">gdf</span><span class="o">=</span><span class="n">gdf_ivt_catchment</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(),</span>
    <span class="n">col</span><span class="o">=</span><span class="s1">&#39;proportion_rural&#39;</span><span class="p">,</span>
    <span class="n">col_readable</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Proportion of people in rural areas in each IVT &#39;</span> <span class="o">+</span>
                  <span class="s1">&#39;catchment area (based on RUC 2011)&#39;</span><span class="p">),</span>
    <span class="n">gdf_units</span><span class="o">=</span><span class="n">gdf_units</span><span class="p">,</span>
    <span class="n">base_map</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">show_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/4f79591daeb94de774d63df7980f086b20960f706d9ae674f250989e33b82c0b.png" src="_images/4f79591daeb94de774d63df7980f086b20960f706d9ae674f250989e33b82c0b.png" />
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;Range: 0.0 to 0.838&#39;
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;Median: 0.22&#39;
</pre></div>
</div>
<img alt="_images/70fe835b768d662c0a5bf6700dcb89ae284d3b45408e2b2a20d0b8c5d2004a3c.png" src="_images/70fe835b768d662c0a5bf6700dcb89ae284d3b45408e2b2a20d0b8c5d2004a3c.png" />
</div>
</div>
</section>
<section id="age-proportion-aged-65-by-ivt-catchment">
<h3>Age - proportion aged 65+ by IVT catchment<a class="headerlink" href="#age-proportion-aged-65-by-ivt-catchment" title="Permalink to this heading">#</a></h3>
<p>The age band reflect the bottom of the band - so age_band_65 is people aged 65, 66, 67, 68 and 69.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Find count of people age 65 plus</span>
<span class="n">df_lsoa</span><span class="p">[</span><span class="s1">&#39;age_65_plus_count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_lsoa</span><span class="p">[[</span>
    <span class="s1">&#39;age_band_all_65&#39;</span><span class="p">,</span> <span class="s1">&#39;age_band_all_70&#39;</span><span class="p">,</span> <span class="s1">&#39;age_band_all_75&#39;</span><span class="p">,</span>
    <span class="s1">&#39;age_band_all_80&#39;</span><span class="p">,</span> <span class="s1">&#39;age_band_all_85&#39;</span><span class="p">,</span> <span class="s1">&#39;age_band_all_90&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Find proportion age 65 plus by IVT catchment</span>
<span class="n">age_65</span> <span class="o">=</span> <span class="n">find_proportion</span><span class="p">(</span>
    <span class="n">subgroup_col</span><span class="o">=</span><span class="s1">&#39;age_65_plus_count&#39;</span><span class="p">,</span>
    <span class="n">overall_col</span><span class="o">=</span><span class="s1">&#39;population_all&#39;</span><span class="p">,</span>
    <span class="n">proportion_col</span><span class="o">=</span><span class="s1">&#39;age_65_plus_proportion&#39;</span><span class="p">,</span>
    <span class="n">group_col</span><span class="o">=</span><span class="s1">&#39;closest_ivt_unit&#39;</span><span class="p">,</span>
    <span class="n">df</span><span class="o">=</span><span class="n">df_lsoa</span>
<span class="p">)</span>

<span class="n">age_65</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>age_65_plus_count</th>
      <th>population_all</th>
      <th>age_65_plus_proportion</th>
    </tr>
    <tr>
      <th>closest_ivt_unit</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>B152TH</th>
      <td>144555</td>
      <td>963012</td>
      <td>0.150107</td>
    </tr>
    <tr>
      <th>B714HJ</th>
      <td>159109</td>
      <td>1012389</td>
      <td>0.157162</td>
    </tr>
    <tr>
      <th>BA13NG</th>
      <td>102838</td>
      <td>483031</td>
      <td>0.212901</td>
    </tr>
    <tr>
      <th>BA214AT</th>
      <td>72947</td>
      <td>274432</td>
      <td>0.265811</td>
    </tr>
    <tr>
      <th>BB23HH</th>
      <td>88140</td>
      <td>486120</td>
      <td>0.181313</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Add proportion to geopandas dataframe</span>
<span class="n">gdf_ivt_catchment</span> <span class="o">=</span> <span class="p">(</span><span class="n">gdf_ivt_catchment</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
    <span class="n">age_65</span><span class="p">[</span><span class="s1">&#39;age_65_plus_proportion&#39;</span><span class="p">]))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create map</span>
<span class="n">create_map</span><span class="p">(</span>
    <span class="n">gdf</span><span class="o">=</span><span class="n">gdf_ivt_catchment</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(),</span>
    <span class="n">col</span><span class="o">=</span><span class="s1">&#39;age_65_plus_proportion&#39;</span><span class="p">,</span>
    <span class="n">col_readable</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Proportion of people aged 65 or older (mid 2020)&#39;</span><span class="p">),</span>
    <span class="n">gdf_units</span><span class="o">=</span><span class="n">gdf_units</span><span class="p">,</span>
    <span class="n">base_map</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">show_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Reds&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/60c41ea63820d8a21b39d750533391f4f00107d2259661b6ec1e2d70636c7231.png" src="_images/60c41ea63820d8a21b39d750533391f4f00107d2259661b6ec1e2d70636c7231.png" />
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;Range: 0.082 to 0.287&#39;
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;Median: 0.203&#39;
</pre></div>
</div>
<img alt="_images/42575e92375bc0ee5f5295e842becb0c5994d1af0031fe8db8fb702230c4b65b.png" src="_images/42575e92375bc0ee5f5295e842becb0c5994d1af0031fe8db8fb702230c4b65b.png" />
</div>
</div>
</section>
<section id="thrombolysis-rates-for-each-ivt-unit">
<h3>Thrombolysis rates for each IVT unit<a class="headerlink" href="#thrombolysis-rates-for-each-ivt-unit" title="Permalink to this heading">#</a></h3>
<p>Thrombolysis rate here is the rate for the closest IVT unit (not specific to LSOAs - so its proportion of all admissions to that unit, not just of those from that LSOA)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Extract rate for each unit, with unit as index</span>
<span class="n">ivt_rate</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_lsoa</span><span class="p">[[</span><span class="s1">&#39;closest_ivt_unit&#39;</span><span class="p">,</span> <span class="s1">&#39;ivt_rate&#39;</span><span class="p">]]</span>
            <span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
            <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;closest_ivt_unit&#39;</span><span class="p">)[</span><span class="s1">&#39;ivt_rate&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Add rate to geopandas dataframe</span>
<span class="n">gdf_ivt_catchment</span> <span class="o">=</span> <span class="p">(</span><span class="n">gdf_ivt_catchment</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ivt_rate</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create map</span>
<span class="n">create_map</span><span class="p">(</span>
    <span class="n">gdf</span><span class="o">=</span><span class="n">gdf_ivt_catchment</span><span class="p">,</span>
    <span class="n">col</span><span class="o">=</span><span class="s1">&#39;ivt_rate&#39;</span><span class="p">,</span>
    <span class="n">col_readable</span><span class="o">=</span><span class="s1">&#39;Thrombolysis rate&#39;</span><span class="p">,</span>
    <span class="n">gdf_units</span><span class="o">=</span><span class="n">gdf_units</span><span class="p">,</span>
    <span class="n">base_map</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">show_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/ef80b9a59e42be8b61355804956798d84b4da5f62ee1e16b965407f95373f4c1.png" src="_images/ef80b9a59e42be8b61355804956798d84b4da5f62ee1e16b965407f95373f4c1.png" />
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;Range: 1.9 to 27.5&#39;
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;Median: 10.6&#39;
</pre></div>
</div>
<img alt="_images/9072ae4eec197dd99107ac22c546d2d208c523df80b5c338c1c9ef7fe7c6a9bb.png" src="_images/9072ae4eec197dd99107ac22c546d2d208c523df80b5c338c1c9ef7fe7c6a9bb.png" />
</div>
</div>
</section>
<section id="population-density">
<h3>Population density<a class="headerlink" href="#population-density" title="Permalink to this heading">#</a></h3>
<p>Calculation of population density based on archive/05_create_proportion_over_65_maps and these stack overflow posts: <a class="reference external" href="https://gis.stackexchange.com/questions/218450/getting-polygon-areas-using-geopandas">post 1</a> and <a class="reference external" href="https://stackoverflow.com/questions/67796160/calculate-density-based-on-lat-lon">post 2</a></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Find population of each IVT catchment</span>
<span class="n">pop</span> <span class="o">=</span> <span class="n">df_lsoa</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;closest_ivt_unit&#39;</span><span class="p">)[</span><span class="s1">&#39;population_all&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Add total population size to geopandas</span>
<span class="n">gdf_ivt_catchment</span> <span class="o">=</span> <span class="p">(</span><span class="n">gdf_ivt_catchment</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pop</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Change the projection to a Cartesian system (EPSG:3857) and get area in</span>
<span class="c1"># square kilometers (through /10**6)</span>
<span class="n">gdf_ivt_catchment</span><span class="p">[</span><span class="s1">&#39;polygon_area&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">gdf_ivt_catchment</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="s1">&#39;epsg:3857&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">area</span> <span class="o">/</span> <span class="mi">10</span><span class="o">**</span><span class="mi">6</span><span class="p">)</span>

<span class="c1"># Divide population by area to get population density</span>
<span class="n">gdf_ivt_catchment</span><span class="p">[</span><span class="s1">&#39;population_density&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">gdf_ivt_catchment</span><span class="p">[</span><span class="s1">&#39;population_all&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">gdf_ivt_catchment</span><span class="p">[</span><span class="s1">&#39;polygon_area&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create map</span>
<span class="n">create_map</span><span class="p">(</span>
    <span class="n">gdf</span><span class="o">=</span><span class="n">gdf_ivt_catchment</span><span class="p">,</span>
    <span class="n">col</span><span class="o">=</span><span class="s1">&#39;population_density&#39;</span><span class="p">,</span>
    <span class="n">col_readable</span><span class="o">=</span><span class="s1">&#39;Population density&#39;</span><span class="p">,</span>
    <span class="n">gdf_units</span><span class="o">=</span><span class="n">gdf_units</span><span class="p">,</span>
    <span class="n">base_map</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">show_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Reds&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/7330d8f0e998839262900e86172b195c8cee7e37a06a142e5f7dc3a81120b4c6.png" src="_images/7330d8f0e998839262900e86172b195c8cee7e37a06a142e5f7dc3a81120b4c6.png" />
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;Range: 9.482 to 4023.447&#39;
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;Median: 152.691&#39;
</pre></div>
</div>
<img alt="_images/9594e2a672d158adb4fbedbaf060aa87da2f203afb25b455ed1da7c6647ee2bd.png" src="_images/9594e2a672d158adb4fbedbaf060aa87da2f203afb25b455ed1da7c6647ee2bd.png" />
</div>
</div>
</section>
<section id="average-travel-time-to-ivt-unit-weighted-by-number-of-over-65-year-olds-in-catchment">
<h3>Average travel time to IVT unit weighted by number of over 65 year olds in catchment<a class="headerlink" href="#average-travel-time-to-ivt-unit-weighted-by-number-of-over-65-year-olds-in-catchment" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Find mean time to IVT weighted by 65+ population size of each LSOA</span>
<span class="n">ivt_time</span> <span class="o">=</span> <span class="n">weighted_av</span><span class="p">(</span>
    <span class="n">df</span><span class="o">=</span><span class="n">df_lsoa</span><span class="p">,</span> <span class="n">group_by</span><span class="o">=</span><span class="s1">&#39;closest_ivt_unit&#39;</span><span class="p">,</span>
    <span class="n">col</span><span class="o">=</span><span class="s1">&#39;closest_ivt_unit_time&#39;</span><span class="p">,</span> <span class="n">new_col</span><span class="o">=</span><span class="s1">&#39;weighted_ivt_time&#39;</span><span class="p">,</span>
    <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;age_65_plus_count&#39;</span><span class="p">)</span>

<span class="n">ivt_time</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>weighted_ivt_time</th>
    </tr>
    <tr>
      <th>closest_ivt_unit</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>B152TH</th>
      <td>18.971119</td>
      <td>19.881289</td>
    </tr>
    <tr>
      <th>B714HJ</th>
      <td>18.613081</td>
      <td>19.355652</td>
    </tr>
    <tr>
      <th>BA13NG</th>
      <td>24.218246</td>
      <td>25.199316</td>
    </tr>
    <tr>
      <th>BA214AT</th>
      <td>23.251572</td>
      <td>24.275645</td>
    </tr>
    <tr>
      <th>BB23HH</th>
      <td>19.500654</td>
      <td>20.295453</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>WD180HB</th>
      <td>19.495918</td>
      <td>19.740606</td>
    </tr>
    <tr>
      <th>WF14DG</th>
      <td>18.663793</td>
      <td>18.843356</td>
    </tr>
    <tr>
      <th>WR51DD</th>
      <td>20.794239</td>
      <td>22.107489</td>
    </tr>
    <tr>
      <th>WV100QP</th>
      <td>18.264433</td>
      <td>19.183549</td>
    </tr>
    <tr>
      <th>YO318HE</th>
      <td>28.439159</td>
      <td>30.242922</td>
    </tr>
  </tbody>
</table>
<p>113 rows × 2 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Add time to geopandas dataframe</span>
<span class="c1"># Add total population size to geopandas</span>
<span class="n">gdf_ivt_catchment</span> <span class="o">=</span> <span class="p">(</span><span class="n">gdf_ivt_catchment</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ivt_time</span><span class="p">[</span><span class="s1">&#39;weighted_ivt_time&#39;</span><span class="p">]))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create map</span>
<span class="n">create_map</span><span class="p">(</span>
    <span class="n">gdf</span><span class="o">=</span><span class="n">gdf_ivt_catchment</span><span class="p">,</span>
    <span class="n">col</span><span class="o">=</span><span class="s1">&#39;weighted_ivt_time&#39;</span><span class="p">,</span>
    <span class="n">col_readable</span><span class="o">=</span><span class="s1">&#39;Average time to IVT unit (weighted by LSOA 65+ population)&#39;</span><span class="p">,</span>
    <span class="n">gdf_units</span><span class="o">=</span><span class="n">gdf_units</span><span class="p">,</span>
    <span class="n">base_map</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">show_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Reds&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/de3ea5771f99f44b33a174667a33b2e87f18360cc26cd2a60044dd4f309b40ee.png" src="_images/de3ea5771f99f44b33a174667a33b2e87f18360cc26cd2a60044dd4f309b40ee.png" />
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;Range: 12.891 to 35.582&#39;
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;Median: 20.089&#39;
</pre></div>
</div>
<img alt="_images/20bea7db7311d70939f393a5be33bd619cc2034cbf87016cac86e2db48ac0939.png" src="_images/20bea7db7311d70939f393a5be33bd619cc2034cbf87016cac86e2db48ac0939.png" />
</div>
</div>
</section>
<section id="proportion-of-65-year-olds-living-within-30-minutes-of-their-closest-ivt-unit">
<h3>Proportion of 65+ year olds living within 30 minutes of their closest IVT unit<a class="headerlink" href="#proportion-of-65-year-olds-living-within-30-minutes-of-their-closest-ivt-unit" title="Permalink to this heading">#</a></h3>
<p>Created as in archive/06_create_ave_travel_time_maps.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create column indicating if IVT unit is within 30 minutes</span>
<span class="n">df_lsoa</span><span class="p">[</span><span class="s1">&#39;ivt_within_30&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_lsoa</span><span class="p">[</span><span class="s1">&#39;closest_ivt_unit_time&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">30</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
    <span class="p">{</span><span class="kc">True</span><span class="p">:</span> <span class="s1">&#39;True&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">:</span> <span class="s1">&#39;False&#39;</span><span class="p">})</span>

<span class="n">df_lsoa</span><span class="o">.</span><span class="n">ivt_within_30</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>ivt_within_30
True     30903
False     3849
Name: count, dtype: int64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Find proportion of over 65 year olds who live within 30 min for each unit</span>
<span class="n">within_30</span> <span class="o">=</span> <span class="n">find_count_and_proportion</span><span class="p">(</span>
    <span class="n">df_lsoa</span><span class="o">=</span><span class="n">df_lsoa</span><span class="p">,</span>
    <span class="n">area</span><span class="o">=</span><span class="s1">&#39;closest_ivt_unit&#39;</span><span class="p">,</span>
    <span class="n">col</span><span class="o">=</span><span class="s1">&#39;ivt_within_30&#39;</span><span class="p">,</span>
    <span class="n">count</span><span class="o">=</span><span class="s1">&#39;age_65_plus_count&#39;</span><span class="p">,</span>
    <span class="n">prop</span><span class="o">=</span><span class="s1">&#39;proportion_over_65_within_30&#39;</span>
<span class="p">)</span>

<span class="n">within_30</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>False</th>
      <th>True</th>
      <th>proportion_over_65_within_30</th>
    </tr>
    <tr>
      <th>closest_ivt_unit</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>B152TH</th>
      <td>6329.0</td>
      <td>138226.0</td>
      <td>0.956217</td>
    </tr>
    <tr>
      <th>B714HJ</th>
      <td>20680.0</td>
      <td>138429.0</td>
      <td>0.870026</td>
    </tr>
    <tr>
      <th>BA13NG</th>
      <td>38113.0</td>
      <td>64725.0</td>
      <td>0.629388</td>
    </tr>
    <tr>
      <th>BA214AT</th>
      <td>27527.0</td>
      <td>45420.0</td>
      <td>0.622644</td>
    </tr>
    <tr>
      <th>BB23HH</th>
      <td>6443.0</td>
      <td>81697.0</td>
      <td>0.926900</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Add to geopandas</span>
<span class="n">gdf_ivt_catchment</span> <span class="o">=</span> <span class="p">(</span><span class="n">gdf_ivt_catchment</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
    <span class="n">within_30</span><span class="p">[</span><span class="s1">&#39;proportion_over_65_within_30&#39;</span><span class="p">]))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create map</span>
<span class="n">create_map</span><span class="p">(</span>
    <span class="n">gdf</span><span class="o">=</span><span class="n">gdf_ivt_catchment</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(),</span>
    <span class="n">col</span><span class="o">=</span><span class="s1">&#39;proportion_over_65_within_30&#39;</span><span class="p">,</span>
    <span class="n">col_readable</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Proportion of people aged 65 or older who live within 30 &#39;</span> <span class="o">+</span>
                  <span class="s1">&#39;minutes of their closest IVT unit&#39;</span><span class="p">),</span>
    <span class="n">gdf_units</span><span class="o">=</span><span class="n">gdf_units</span><span class="p">,</span>
    <span class="n">base_map</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">show_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Reds_r&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/fef689f14febb5e16dd26dfe6e0637d69c89f58fbc0d46557f031e806f6fe248.png" src="_images/fef689f14febb5e16dd26dfe6e0637d69c89f58fbc0d46557f031e806f6fe248.png" />
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;Range: 0.359 to 1.0&#39;
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;Median: 0.907&#39;
</pre></div>
</div>
<img alt="_images/b338dce91e134acbbcefc458e104725f5ad657e451620b7902d06260a59a0c3a.png" src="_images/b338dce91e134acbbcefc458e104725f5ad657e451620b7902d06260a59a0c3a.png" />
</div>
</div>
</section>
</section>
<section id="ambulance-service-statistics">
<h2>3 Ambulance service statistics<a class="headerlink" href="#ambulance-service-statistics" title="Permalink to this heading">#</a></h2>
<section id="ambulance-service-map">
<h3>Ambulance service map<a class="headerlink" href="#ambulance-service-map" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Add ambulance service as a column for the mapping function</span>
<span class="n">gdf_amb_catchment</span><span class="p">[</span><span class="s1">&#39;ambulance_service&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gdf_amb_catchment</span><span class="o">.</span><span class="n">index</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create map</span>
<span class="n">create_map</span><span class="p">(</span>
    <span class="n">gdf</span><span class="o">=</span><span class="n">gdf_amb_catchment</span><span class="p">,</span>
    <span class="n">col</span><span class="o">=</span><span class="s1">&#39;ambulance_service&#39;</span><span class="p">,</span>
    <span class="n">col_readable</span><span class="o">=</span><span class="s1">&#39;Ambulance service map (based on CCG or county of each LSOA)&#39;</span><span class="p">,</span>
    <span class="n">gdf_units</span><span class="o">=</span><span class="n">gdf_units</span><span class="p">,</span>
    <span class="n">base_map</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">show_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/18a73766c8eeb67f96d9e4871faeee5c4fc7399bd678306ce69218656297b49f.png" src="_images/18a73766c8eeb67f96d9e4871faeee5c4fc7399bd678306ce69218656297b49f.png" />
</div>
</div>
</section>
<section id="population-weighted-mean-time-to-ivt-unit-by-ambulance-trust">
<h3>Population-weighted mean time to IVT unit by ambulance trust<a class="headerlink" href="#population-weighted-mean-time-to-ivt-unit-by-ambulance-trust" title="Permalink to this heading">#</a></h3>
<p>This is the population weighted mean time to the closest unit providing thrombolysis (IVT), which may also be referred to as a hyper acute stroke service (HASU). It is population weighted as we have mean time per LSOA, so we weight by the number of individuals in each LSOA.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Weight mean time to closest IVT unit by ambulance service</span>
<span class="n">df_amb_ivt_time</span> <span class="o">=</span> <span class="n">weighted_av</span><span class="p">(</span>
    <span class="n">df_lsoa</span><span class="p">,</span> <span class="n">group_by</span><span class="o">=</span><span class="s1">&#39;ambulance_service&#39;</span><span class="p">,</span>
    <span class="n">col</span><span class="o">=</span><span class="s1">&#39;closest_ivt_unit_time&#39;</span><span class="p">,</span> <span class="n">new_col</span><span class="o">=</span><span class="s1">&#39;ivt_time_weighted_mean&#39;</span><span class="p">)</span>
<span class="n">df_amb_ivt_time</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;ivt_time_weighted_mean&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>ivt_time_weighted_mean</th>
    </tr>
    <tr>
      <th>ambulance_service</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>London</th>
      <td>16.379483</td>
      <td>16.304175</td>
    </tr>
    <tr>
      <th>North East</th>
      <td>17.977248</td>
      <td>17.842487</td>
    </tr>
    <tr>
      <th>Isle of Wight</th>
      <td>18.789888</td>
      <td>18.605475</td>
    </tr>
    <tr>
      <th>North West</th>
      <td>18.845056</td>
      <td>18.851069</td>
    </tr>
    <tr>
      <th>West Midlands</th>
      <td>19.284198</td>
      <td>19.177783</td>
    </tr>
    <tr>
      <th>Yorkshire</th>
      <td>19.553911</td>
      <td>19.277658</td>
    </tr>
    <tr>
      <th>South Central</th>
      <td>19.810180</td>
      <td>19.808518</td>
    </tr>
    <tr>
      <th>Welsh</th>
      <td>20.272813</td>
      <td>20.130240</td>
    </tr>
    <tr>
      <th>East of England</th>
      <td>20.745680</td>
      <td>20.717194</td>
    </tr>
    <tr>
      <th>South East Coast</th>
      <td>20.879474</td>
      <td>20.826622</td>
    </tr>
    <tr>
      <th>East Midlands</th>
      <td>21.243307</td>
      <td>21.218572</td>
    </tr>
    <tr>
      <th>South West</th>
      <td>21.566687</td>
      <td>21.636569</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Add mean to geopandas dataframe</span>
<span class="n">gdf_amb_catchment</span> <span class="o">=</span> <span class="p">(</span><span class="n">gdf_amb_catchment</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
    <span class="n">df_amb_ivt_time</span><span class="p">[</span><span class="s1">&#39;ivt_time_weighted_mean&#39;</span><span class="p">]))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create map</span>
<span class="n">create_map</span><span class="p">(</span>
    <span class="n">gdf</span><span class="o">=</span><span class="n">gdf_amb_catchment</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(),</span>
    <span class="n">col</span><span class="o">=</span><span class="s1">&#39;ivt_time_weighted_mean&#39;</span><span class="p">,</span>
    <span class="n">col_readable</span><span class="o">=</span><span class="s1">&#39;Weighted mean time to closest IVT unit by ambulance trust&#39;</span><span class="p">,</span>
    <span class="n">gdf_units</span><span class="o">=</span><span class="n">gdf_units</span><span class="p">,</span>
    <span class="n">base_map</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">show_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Reds&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/b34fd825f2bc32ddc419ad0311be29d3bd132e613c6336ecd712fae586542e78.png" src="_images/b34fd825f2bc32ddc419ad0311be29d3bd132e613c6336ecd712fae586542e78.png" />
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;Range: 16.304 to 21.637&#39;
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;Median: 19.543&#39;
</pre></div>
</div>
<img alt="_images/672e2a49fe4193df4cd2d220ebd1c5459ec1b3007d843778dfc64909dcdd556b.png" src="_images/672e2a49fe4193df4cd2d220ebd1c5459ec1b3007d843778dfc64909dcdd556b.png" />
</div>
</div>
</section>
<section id="population-weighted-mean-time-to-mt-unit-by-ambulance-trust">
<h3>Population-weighted mean time to MT unit by ambulance trust<a class="headerlink" href="#population-weighted-mean-time-to-mt-unit-by-ambulance-trust" title="Permalink to this heading">#</a></h3>
<p>MT unit might also be referred to as Comprehensive Stroke Centre (CSC).</p>
<p>This considers transfers - i.e. combines (1) time from home to closest IVT unit, and (2) transfer time to its closest MT unit (which, if the same unit, is 0)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Weight mean time to thrombectomy unit by ambulance service</span>
<span class="n">df_amb_mt_time</span> <span class="o">=</span> <span class="n">weighted_av</span><span class="p">(</span>
    <span class="n">df_lsoa</span><span class="p">,</span> <span class="n">group_by</span><span class="o">=</span><span class="s1">&#39;ambulance_service&#39;</span><span class="p">,</span>
    <span class="n">col</span><span class="o">=</span><span class="s1">&#39;total_mt_time&#39;</span><span class="p">,</span> <span class="n">new_col</span><span class="o">=</span><span class="s1">&#39;mt_time_weighted_mean&#39;</span><span class="p">)</span>
<span class="n">df_amb_mt_time</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;mt_time_weighted_mean&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>mt_time_weighted_mean</th>
    </tr>
    <tr>
      <th>ambulance_service</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>London</th>
      <td>25.917497</td>
      <td>25.450542</td>
    </tr>
    <tr>
      <th>West Midlands</th>
      <td>37.916748</td>
      <td>37.530963</td>
    </tr>
    <tr>
      <th>Yorkshire</th>
      <td>38.175378</td>
      <td>38.060249</td>
    </tr>
    <tr>
      <th>North West</th>
      <td>39.155098</td>
      <td>38.608323</td>
    </tr>
    <tr>
      <th>North East</th>
      <td>43.506337</td>
      <td>43.203993</td>
    </tr>
    <tr>
      <th>South Central</th>
      <td>47.813957</td>
      <td>47.961602</td>
    </tr>
    <tr>
      <th>East Midlands</th>
      <td>51.961945</td>
      <td>52.201445</td>
    </tr>
    <tr>
      <th>South East Coast</th>
      <td>60.718024</td>
      <td>60.631874</td>
    </tr>
    <tr>
      <th>South West</th>
      <td>63.863551</td>
      <td>64.049319</td>
    </tr>
    <tr>
      <th>Welsh</th>
      <td>64.987114</td>
      <td>64.959504</td>
    </tr>
    <tr>
      <th>East of England</th>
      <td>66.040353</td>
      <td>65.884606</td>
    </tr>
    <tr>
      <th>Isle of Wight</th>
      <td>136.289888</td>
      <td>136.105475</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Add mean to geopandas dataframe</span>
<span class="n">gdf_amb_catchment</span> <span class="o">=</span> <span class="p">(</span><span class="n">gdf_amb_catchment</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
    <span class="n">df_amb_mt_time</span><span class="p">[</span><span class="s1">&#39;mt_time_weighted_mean&#39;</span><span class="p">]))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create map</span>
<span class="n">create_map</span><span class="p">(</span>
    <span class="n">gdf</span><span class="o">=</span><span class="n">gdf_amb_catchment</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(),</span>
    <span class="n">col</span><span class="o">=</span><span class="s1">&#39;mt_time_weighted_mean&#39;</span><span class="p">,</span>
    <span class="n">col_readable</span><span class="o">=</span><span class="s1">&#39;Weighted mean time to thrombectomy unit by ambulance trust&#39;</span><span class="p">,</span>
    <span class="n">gdf_units</span><span class="o">=</span><span class="n">gdf_units</span><span class="p">,</span>
    <span class="n">base_map</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">show_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Reds&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/5d2c38856e8d697b468d2d4aff2e2285a9409a7db03f3b86763310934ae980af.png" src="_images/5d2c38856e8d697b468d2d4aff2e2285a9409a7db03f3b86763310934ae980af.png" />
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;Range: 25.451 to 136.105&#39;
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;Median: 50.082&#39;
</pre></div>
</div>
<img alt="_images/745af19600ce406f263cd2c89ae30abdafb3a4de12a6addcefe6b1eb73913ddf.png" src="_images/745af19600ce406f263cd2c89ae30abdafb3a4de12a6addcefe6b1eb73913ddf.png" />
</div>
</div>
</section>
<section id="population-weighted-mean-transfer-time-between-ivt-and-mt-unit">
<h3>Population-weighted mean transfer time between IVT and MT unit<a class="headerlink" href="#population-weighted-mean-transfer-time-between-ivt-and-mt-unit" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Weight mean transfer time by ambulance trust</span>
<span class="n">df_amb_transfer_time</span> <span class="o">=</span> <span class="n">weighted_av</span><span class="p">(</span>
    <span class="n">df_lsoa</span><span class="p">,</span> <span class="n">group_by</span><span class="o">=</span><span class="s1">&#39;ambulance_service&#39;</span><span class="p">,</span>
    <span class="n">col</span><span class="o">=</span><span class="s1">&#39;closest_mt_transfer_time&#39;</span><span class="p">,</span> <span class="n">new_col</span><span class="o">=</span><span class="s1">&#39;mt_transfer_time_weighted_mean&#39;</span><span class="p">)</span>
<span class="n">df_amb_transfer_time</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;mt_transfer_time_weighted_mean&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>mt_transfer_time_weighted_mean</th>
    </tr>
    <tr>
      <th>ambulance_service</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>London</th>
      <td>9.538014</td>
      <td>9.146366</td>
    </tr>
    <tr>
      <th>West Midlands</th>
      <td>18.632549</td>
      <td>18.353180</td>
    </tr>
    <tr>
      <th>Yorkshire</th>
      <td>18.621468</td>
      <td>18.782592</td>
    </tr>
    <tr>
      <th>North West</th>
      <td>20.310042</td>
      <td>19.757255</td>
    </tr>
    <tr>
      <th>North East</th>
      <td>25.529089</td>
      <td>25.361506</td>
    </tr>
    <tr>
      <th>South Central</th>
      <td>28.003777</td>
      <td>28.153084</td>
    </tr>
    <tr>
      <th>East Midlands</th>
      <td>30.718638</td>
      <td>30.982873</td>
    </tr>
    <tr>
      <th>South East Coast</th>
      <td>39.838550</td>
      <td>39.805252</td>
    </tr>
    <tr>
      <th>South West</th>
      <td>42.296864</td>
      <td>42.412750</td>
    </tr>
    <tr>
      <th>Welsh</th>
      <td>44.714301</td>
      <td>44.829263</td>
    </tr>
    <tr>
      <th>East of England</th>
      <td>45.294673</td>
      <td>45.167412</td>
    </tr>
    <tr>
      <th>Isle of Wight</th>
      <td>117.500000</td>
      <td>117.500000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Add mean to geopandas dataframe</span>
<span class="n">gdf_amb_catchment</span> <span class="o">=</span> <span class="p">(</span><span class="n">gdf_amb_catchment</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
    <span class="n">df_amb_transfer_time</span><span class="p">[</span><span class="s1">&#39;mt_transfer_time_weighted_mean&#39;</span><span class="p">]))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create map</span>
<span class="n">create_map</span><span class="p">(</span>
    <span class="n">gdf</span><span class="o">=</span><span class="n">gdf_amb_catchment</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(),</span>
    <span class="n">col</span><span class="o">=</span><span class="s1">&#39;mt_transfer_time_weighted_mean&#39;</span><span class="p">,</span>
    <span class="n">col_readable</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Weighted mean transfer time between IVT and MT unit &#39;</span> <span class="o">+</span>
                  <span class="s1">&#39;by ambulance trust&#39;</span><span class="p">),</span>
    <span class="n">gdf_units</span><span class="o">=</span><span class="n">gdf_units</span><span class="p">,</span>
    <span class="n">base_map</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">show_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Reds&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/9bbae78da1ac18a0e546f1df75cb1693e47f4b136ea94ea6cac92e00d0282f31.png" src="_images/9bbae78da1ac18a0e546f1df75cb1693e47f4b136ea94ea6cac92e00d0282f31.png" />
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;Range: 9.146 to 117.5&#39;
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;Median: 29.568&#39;
</pre></div>
</div>
<img alt="_images/93db6473d7f33b1f9fcc46db41d79b0bc3ef4544730e39ea8d1d03cdb99d8c35.png" src="_images/93db6473d7f33b1f9fcc46db41d79b0bc3ef4544730e39ea8d1d03cdb99d8c35.png" />
</div>
</div>
</section>
<section id="proportion-of-patients-whose-nearest-hospital-is-an-mt-unit">
<h3>Proportion of patients whose nearest hospital is an MT unit<a class="headerlink" href="#proportion-of-patients-whose-nearest-hospital-is-an-mt-unit" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Add column with whether closest hospital offers thrombectomy</span>
<span class="n">df_lsoa</span><span class="p">[</span><span class="s1">&#39;closest_hospital_is_mt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">df_lsoa</span><span class="p">[</span><span class="s1">&#39;closest_mt_transfer_time&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">({</span><span class="kc">True</span><span class="p">:</span> <span class="s1">&#39;True&#39;</span><span class="p">,</span>
                                                   <span class="kc">False</span><span class="p">:</span> <span class="s1">&#39;False&#39;</span><span class="p">})</span>
<span class="n">df_lsoa</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>LSOA</th>
      <th>admissions</th>
      <th>closest_ivt_unit</th>
      <th>closest_ivt_unit_time</th>
      <th>closest_mt_unit</th>
      <th>closest_mt_unit_time</th>
      <th>closest_mt_transfer</th>
      <th>closest_mt_transfer_time</th>
      <th>total_mt_time</th>
      <th>ivt_rate</th>
      <th>...</th>
      <th>local_authority_district_22</th>
      <th>LAD22NM</th>
      <th>country</th>
      <th>ethnic_group_not_white</th>
      <th>long_term_health_count</th>
      <th>ruc_overall</th>
      <th>rural</th>
      <th>age_65_plus_count</th>
      <th>ivt_within_30</th>
      <th>closest_hospital_is_mt</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Welwyn Hatfield 010F</td>
      <td>0.666667</td>
      <td>SG14AB</td>
      <td>18.7</td>
      <td>NW12BU</td>
      <td>36.9</td>
      <td>CB20QQ</td>
      <td>39.1</td>
      <td>57.8</td>
      <td>6.8</td>
      <td>...</td>
      <td>Welwyn Hatfield</td>
      <td>Welwyn Hatfield</td>
      <td>England</td>
      <td>279</td>
      <td>194</td>
      <td>Urban</td>
      <td>False</td>
      <td>212</td>
      <td>True</td>
      <td>False</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Welwyn Hatfield 012A</td>
      <td>4.000000</td>
      <td>SG14AB</td>
      <td>19.8</td>
      <td>NW12BU</td>
      <td>36.9</td>
      <td>CB20QQ</td>
      <td>39.1</td>
      <td>58.9</td>
      <td>6.8</td>
      <td>...</td>
      <td>Welwyn Hatfield</td>
      <td>Welwyn Hatfield</td>
      <td>England</td>
      <td>388</td>
      <td>247</td>
      <td>Urban</td>
      <td>False</td>
      <td>203</td>
      <td>True</td>
      <td>False</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Welwyn Hatfield 002F</td>
      <td>2.000000</td>
      <td>SG14AB</td>
      <td>18.7</td>
      <td>NW12BU</td>
      <td>38.0</td>
      <td>CB20QQ</td>
      <td>39.1</td>
      <td>57.8</td>
      <td>6.8</td>
      <td>...</td>
      <td>Welwyn Hatfield</td>
      <td>Welwyn Hatfield</td>
      <td>England</td>
      <td>224</td>
      <td>125</td>
      <td>Urban</td>
      <td>False</td>
      <td>193</td>
      <td>True</td>
      <td>False</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Welwyn Hatfield 002E</td>
      <td>0.666667</td>
      <td>SG14AB</td>
      <td>18.7</td>
      <td>NW12BU</td>
      <td>36.9</td>
      <td>CB20QQ</td>
      <td>39.1</td>
      <td>57.8</td>
      <td>6.8</td>
      <td>...</td>
      <td>Welwyn Hatfield</td>
      <td>Welwyn Hatfield</td>
      <td>England</td>
      <td>332</td>
      <td>129</td>
      <td>Urban</td>
      <td>False</td>
      <td>156</td>
      <td>True</td>
      <td>False</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Welwyn Hatfield 010A</td>
      <td>3.333333</td>
      <td>SG14AB</td>
      <td>18.7</td>
      <td>NW12BU</td>
      <td>36.9</td>
      <td>CB20QQ</td>
      <td>39.1</td>
      <td>57.8</td>
      <td>6.8</td>
      <td>...</td>
      <td>Welwyn Hatfield</td>
      <td>Welwyn Hatfield</td>
      <td>England</td>
      <td>200</td>
      <td>276</td>
      <td>Urban</td>
      <td>False</td>
      <td>256</td>
      <td>True</td>
      <td>False</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 122 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Find proportion of people whose closest unit offers MT, for each trust</span>
<span class="n">mt_counts</span> <span class="o">=</span> <span class="n">find_count_and_proportion</span><span class="p">(</span>
    <span class="n">df_lsoa</span><span class="o">=</span><span class="n">df_lsoa</span><span class="p">,</span>
    <span class="n">area</span><span class="o">=</span><span class="s1">&#39;ambulance_service&#39;</span><span class="p">,</span>
    <span class="n">col</span><span class="o">=</span><span class="s1">&#39;closest_hospital_is_mt&#39;</span><span class="p">,</span>
    <span class="n">count</span><span class="o">=</span><span class="s1">&#39;population_all&#39;</span><span class="p">,</span>
    <span class="n">prop</span><span class="o">=</span><span class="s1">&#39;proportion_closest_is_mt&#39;</span>
<span class="p">)</span>

<span class="n">mt_counts</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>False</th>
      <th>True</th>
      <th>proportion_closest_is_mt</th>
    </tr>
    <tr>
      <th>ambulance_service</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>East Midlands</th>
      <td>4128292.0</td>
      <td>1018729.0</td>
      <td>0.197926</td>
    </tr>
    <tr>
      <th>East of England</th>
      <td>5433023.0</td>
      <td>853208.0</td>
      <td>0.135726</td>
    </tr>
    <tr>
      <th>Isle of Wight</th>
      <td>142296.0</td>
      <td>0.0</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>London</th>
      <td>2861272.0</td>
      <td>6141216.0</td>
      <td>0.682169</td>
    </tr>
    <tr>
      <th>North East</th>
      <td>1970544.0</td>
      <td>710219.0</td>
      <td>0.264932</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Add proportion to geopandas dataframe</span>
<span class="n">gdf_amb_catchment</span> <span class="o">=</span> <span class="p">(</span><span class="n">gdf_amb_catchment</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
    <span class="n">mt_counts</span><span class="p">[</span><span class="s1">&#39;proportion_closest_is_mt&#39;</span><span class="p">]))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create map</span>
<span class="n">create_map</span><span class="p">(</span>
    <span class="n">gdf</span><span class="o">=</span><span class="n">gdf_amb_catchment</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(),</span>
    <span class="n">col</span><span class="o">=</span><span class="s1">&#39;proportion_closest_is_mt&#39;</span><span class="p">,</span>
    <span class="n">col_readable</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Proportion of people in each ambulance trust whose &#39;</span> <span class="o">+</span>
                  <span class="s1">&#39;stroke unit is one that offers thrombectomy&#39;</span><span class="p">),</span>
    <span class="n">gdf_units</span><span class="o">=</span><span class="n">gdf_units</span><span class="p">,</span>
    <span class="n">base_map</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">show_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Reds_r&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/59f0cc16252df05cf86613b613835fbb7bcd19bbcbb889fc1174d57d287161d1.png" src="_images/59f0cc16252df05cf86613b613835fbb7bcd19bbcbb889fc1174d57d287161d1.png" />
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;Range: 0.0 to 0.682&#39;
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;Median: 0.241&#39;
</pre></div>
</div>
<img alt="_images/016ce8cc2dd797349d31c68c12c6a26f9383c89911ae4363e40914c245973679.png" src="_images/016ce8cc2dd797349d31c68c12c6a26f9383c89911ae4363e40914c245973679.png" />
</div>
</div>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  <!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev"
       href="02_create_shapefiles.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Create shapefiles</p>
      </div>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#set-up">1 Set up</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#import-libraries-and-define-file-paths">1.1 Import libraries and define file paths</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#load-data">1.2 Load data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#define-functions-for-calculating-weighted-mean-and-proportions">1.3 Define functions for calculating weighted mean and proportions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#extract-boundaries">1.4 Extract boundaries</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#define-mapping-functions">1.5 Define mapping functions</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#ivt-catchment-statistics">2 IVT catchment statistics</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#ivt-catchment-map">IVT catchment map</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#admissions-to-each-unit-2021-22">Admissions to each unit (2021-22)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#population-weighted-mean-income-domain-score-by-ivt-catchment">Population-weighted mean income domain score by IVT catchment</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#population-weighted-mean-imd-score-by-ivt-catchment">Population-weighted mean IMD score by IVT catchment</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#ivt-catchment-size">IVT catchment size</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#ethnicity-proportion-ethnic-minority-by-ivt-catchment">Ethnicity - proportion ethnic minority by IVT catchment</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#general-health-proportion-with-bad-very-bad-health-by-ivt-catchment">General health - proportion with bad/very bad health by IVT catchment</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#long-term-health-problem-or-disability-proportion-by-ivt-catchment">Long-term health problem or disability - proportion by IVT catchment</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#rural-urban-proportion-of-people-living-in-rural-areas-by-ivt-catchment">Rural/urban - proportion of people living in rural areas by IVT catchment</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#age-proportion-aged-65-by-ivt-catchment">Age - proportion aged 65+ by IVT catchment</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#thrombolysis-rates-for-each-ivt-unit">Thrombolysis rates for each IVT unit</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#population-density">Population density</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#average-travel-time-to-ivt-unit-weighted-by-number-of-over-65-year-olds-in-catchment">Average travel time to IVT unit weighted by number of over 65 year olds in catchment</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#proportion-of-65-year-olds-living-within-30-minutes-of-their-closest-ivt-unit">Proportion of 65+ year olds living within 30 minutes of their closest IVT unit</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#ambulance-service-statistics">3 Ambulance service statistics</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#ambulance-service-map">Ambulance service map</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#population-weighted-mean-time-to-ivt-unit-by-ambulance-trust">Population-weighted mean time to IVT unit by ambulance trust</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#population-weighted-mean-time-to-mt-unit-by-ambulance-trust">Population-weighted mean time to MT unit by ambulance trust</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#population-weighted-mean-transfer-time-between-ivt-and-mt-unit">Population-weighted mean transfer time between IVT and MT unit</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#proportion-of-patients-whose-nearest-hospital-is-an-mt-unit">Proportion of patients whose nearest hospital is an MT unit</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By SAMueL-2 team
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright 2022.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=ac02cc09edc035673794"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=ac02cc09edc035673794"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>